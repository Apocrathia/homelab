---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Values.app.name }}
  namespace: {{ .Values.app.namespace | default .Values.app.name }}
spec:
  replicas: {{ .Values.app.replicas | default 2 }}
  strategy:
    {{- if and .Values.app.strategy (kindIs "map" .Values.app.strategy) (hasKey .Values.app.strategy "rollingUpdate") }}
    type: RollingUpdate
    rollingUpdate:
      maxSurge: {{ .Values.app.strategy.rollingUpdate.maxSurge | default "25%" }}
      maxUnavailable: {{ .Values.app.strategy.rollingUpdate.maxUnavailable | default "25%" }}
    {{- else if eq (toString .Values.app.strategy) "RollingUpdate" }}
    type: RollingUpdate
    rollingUpdate:
      maxSurge: "25%"
      maxUnavailable: "25%"
    {{- else }}
    type: Recreate
    {{- end }}
  selector:
    matchLabels:
      app: {{ .Values.app.name }}
  template:
    metadata:
      labels:
        app: {{ .Values.app.name }}
    spec:
      {{- if .Values.app.podAntiAffinity.enabled }}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - {{ .Values.app.name }}
                topologyKey: kubernetes.io/hostname
      {{- end }}
      securityContext:
        runAsNonRoot: {{ .Values.app.securityContext.runAsNonRoot | default true }}
        runAsUser: {{ .Values.app.securityContext.runAsUser | default 1000 }}
        runAsGroup: {{ .Values.app.securityContext.runAsGroup | default 1000 }}
        fsGroup: {{ .Values.app.securityContext.fsGroup | default 1000 }}
        {{- if .Values.app.securityContext.fsGroupChangePolicy }}
        fsGroupChangePolicy: {{ .Values.app.securityContext.fsGroupChangePolicy }}
        {{- end }}
        seccompProfile:
          type: RuntimeDefault
      {{- if .Values.app.initContainers }}
      initContainers:
        {{- range .Values.app.initContainers }}
        - name: {{ .name }}
          image: {{ .image }}
          {{- if .command }}
          command: {{ .command | toYaml | nindent 12 }}
          {{- end }}
          {{- if .args }}
          args: {{ .args | toYaml | nindent 12 }}
          {{- end }}
          {{- if .env }}
          env:
            {{- range .env }}
            - name: {{ .name }}
              {{- if .value }}
              value: {{ .value | quote }}
              {{- else if .valueFrom }}
              valueFrom: {{ .valueFrom | toYaml | nindent 16 }}
              {{- end }}
            {{- end }}
          {{- end }}
          volumeMounts:
            {{- if .volumeMounts }}
            {{- range .volumeMounts }}
            - name: {{ $.Values.app.name }}-{{ .name }}
              mountPath: {{ .mountPath }}
              {{- if .subPath }}
              subPath: {{ .subPath }}
              {{- end }}
              {{- if .readOnly }}
              readOnly: {{ .readOnly }}
              {{- end }}
            {{- end }}
            {{- end }}
            {{- if .volumes }}
            {{- range .volumes.emptyDir }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
            {{- end }}
            {{- range .volumes.configMap }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
              {{- if .subPath }}
              subPath: {{ .subPath }}
              {{- end }}
              {{- if .readOnly }}
              readOnly: {{ .readOnly }}
              {{- end }}
            {{- end }}
            {{- end }}
          {{- if .securityContext }}
          securityContext:
            {{- if .securityContext.runAsUser }}
            runAsUser: {{ .securityContext.runAsUser }}
            {{- end }}
            {{- if .securityContext.runAsGroup }}
            runAsGroup: {{ .securityContext.runAsGroup }}
            {{- end }}
            {{- if .securityContext.runAsNonRoot }}
            runAsNonRoot: {{ .securityContext.runAsNonRoot }}
            {{- end }}
            {{- if .securityContext.allowPrivilegeEscalation }}
            allowPrivilegeEscalation: {{ .securityContext.allowPrivilegeEscalation }}
            {{- end }}
            {{- if .securityContext.capabilities }}
            capabilities:
              {{- if .securityContext.capabilities.add }}
              add:
                {{- range .securityContext.capabilities.add }}
                - {{ . }}
                {{- end }}
              {{- end }}
              {{- if .securityContext.capabilities.drop }}
              drop:
                {{- range .securityContext.capabilities.drop }}
                - {{ . }}
                {{- end }}
              {{- end }}
            {{- end }}
          {{- end }}
          {{- if .resources }}
          resources:
            {{- if .resources.requests }}
            requests:
              {{- if .resources.requests.cpu }}
              cpu: {{ .resources.requests.cpu }}
              {{- end }}
              {{- if .resources.requests.memory }}
              memory: {{ .resources.requests.memory }}
              {{- end }}
            {{- end }}
            {{- if .resources.limits }}
            limits:
              {{- if .resources.limits.cpu }}
              cpu: {{ .resources.limits.cpu }}
              {{- end }}
              {{- if .resources.limits.memory }}
              memory: {{ .resources.limits.memory }}
              {{- end }}
            {{- end }}
          {{- end }}
          {{- if .restartPolicy }}
          restartPolicy: {{ .restartPolicy }}
          {{- end }}
          {{- if .lifecycle }}
          lifecycle:
            {{- if .lifecycle.postStart }}
            postStart:
              {{- if .lifecycle.postStart.exec }}
              exec:
                command: {{ .lifecycle.postStart.exec.command | toYaml | nindent 16 }}
              {{- else if .lifecycle.postStart.httpGet }}
              httpGet: {{ .lifecycle.postStart.httpGet | toYaml | nindent 14 }}
              {{- else if .lifecycle.postStart.tcpSocket }}
              tcpSocket: {{ .lifecycle.postStart.tcpSocket | toYaml | nindent 14 }}
              {{- end }}
            {{- end }}
            {{- if .lifecycle.preStop }}
            preStop:
              {{- if .lifecycle.preStop.exec }}
              exec:
                command: {{ .lifecycle.preStop.exec.command | toYaml | nindent 16 }}
              {{- else if .lifecycle.preStop.httpGet }}
              httpGet: {{ .lifecycle.preStop.httpGet | toYaml | nindent 14 }}
              {{- else if .lifecycle.preStop.tcpSocket }}
              tcpSocket: {{ .lifecycle.preStop.tcpSocket | toYaml | nindent 14 }}
              {{- end }}
            {{- end }}
          {{- end }}
          {{- if .stopSignal }}
          stopSignal: {{ .stopSignal }}
          {{- end }}
        {{- end }}
      {{- end }}
      containers:
        - name: {{ .Values.app.container.name | default "main" }}
          image: {{ .Values.app.image | default "nginx:alpine" }}
          {{- if .Values.app.command }}
          command: {{ .Values.app.command | toYaml | nindent 12 }}
          {{- end }}
          {{- if .Values.app.args }}
          args: {{ .Values.app.args | toYaml | nindent 12 }}
          {{- end }}
          ports:
            - containerPort: {{ .Values.app.container.port | default 80 }}
            {{- if .Values.app.container.extraPorts }}
            {{- range .Values.app.container.extraPorts }}
            - containerPort: {{ .containerPort }}
              {{- if .name }}
              name: {{ .name }}
              {{- end }}
              protocol: {{ .protocol | default "TCP" }}
            {{- end }}
            {{- end }}
          {{- if .Values.app.container.env }}
          env:
            {{- range .Values.app.container.env }}
            - name: {{ .name }}
              {{- if .value }}
              value: {{ .value | quote }}
              {{- else if .valueFrom }}
              valueFrom: {{ .valueFrom | toYaml | nindent 16 }}
              {{- end }}
            {{- end }}
          {{- end }}
          securityContext:
            allowPrivilegeEscalation: {{ .Values.app.securityContext.allowPrivilegeEscalation | default false }}
            capabilities:
              {{- if .Values.app.securityContext.capabilities }}
              {{- if .Values.app.securityContext.capabilities.add }}
              add:
                {{- range .Values.app.securityContext.capabilities.add }}
                - {{ . }}
                {{- end }}
              {{- end }}
              {{- if .Values.app.securityContext.capabilities.drop }}
              drop:
                {{- range .Values.app.securityContext.capabilities.drop }}
                - {{ . }}
                {{- end }}
              {{- else }}
              drop:
                - ALL
              {{- end }}
              {{- else }}
              drop:
                - ALL
              {{- end }}
            runAsNonRoot: {{ .Values.app.securityContext.runAsNonRoot | default true }}
            runAsUser: {{ .Values.app.securityContext.runAsUser | default 1000 }}
            readOnlyRootFilesystem: {{ .Values.app.securityContext.readOnlyRootFilesystem | default true }}
            seccompProfile:
              type: RuntimeDefault
          volumeMounts:
            {{- if .Values.app.volumeMounts }}
            {{- range .Values.app.volumeMounts }}
            - name: {{ $.Values.app.name }}-{{ .name }}
              mountPath: {{ .mountPath }}
              {{- if .subPath }}
              subPath: {{ .subPath }}
              {{- end }}
              {{- if .readOnly }}
              readOnly: {{ .readOnly }}
              {{- end }}
            {{- end }}
            {{- end }}
            {{- if .Values.app.volumes.emptyDir }}
            {{- range .Values.app.volumes.emptyDir }}
            - name: {{ $.Values.app.name }}-{{ .name }}
              mountPath: {{ .mountPath }}
            {{- end }}
            {{- end }}
            {{- if .Values.app.volumes.tmpfs }}
            {{- range .Values.app.volumes.tmpfs }}
            - name: {{ $.Values.app.name }}-{{ .name }}
              mountPath: {{ .mountPath }}
            {{- end }}
            {{- end }}
            {{- if .Values.app.volumes.configMap }}
            {{- range .Values.app.volumes.configMap }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
              {{- if .subPath }}
              subPath: {{ .subPath }}
              {{- end }}
              {{- if .readOnly }}
              readOnly: {{ .readOnly }}
              {{- end }}
            {{- end }}
            {{- end }}
          resources:
            requests:
              cpu: {{ .Values.app.resources.requests.cpu | default "50m" }}
              memory: {{ .Values.app.resources.requests.memory | default "64Mi" }}
            limits:
              cpu: {{ .Values.app.resources.limits.cpu | default "100m" }}
              memory: {{ .Values.app.resources.limits.memory | default "128Mi" }}
        {{- if .Values.app.sidecars }}
        {{- range .Values.app.sidecars }}
        - name: {{ .name }}
          image: {{ .image }}
          {{- if .command }}
          command: {{ .command | toYaml | nindent 12 }}
          {{- end }}
          {{- if .args }}
          args: {{ .args | toYaml | nindent 12 }}
          {{- end }}
          {{- if .ports }}
          ports:
            {{- range .ports }}
            - containerPort: {{ .containerPort }}
              {{- if .name }}
              name: {{ .name }}
              {{- end }}
              protocol: {{ .protocol | default "TCP" }}
            {{- end }}
          {{- end }}
          {{- if .env }}
          env:
            {{- range .env }}
            - name: {{ .name }}
              {{- if .value }}
              value: {{ .value | quote }}
              {{- else if .valueFrom }}
              valueFrom: {{ .valueFrom | toYaml | nindent 16 }}
              {{- end }}
            {{- end }}
          {{- end }}
          {{- if .securityContext }}
          securityContext:
            {{- if .securityContext.allowPrivilegeEscalation }}
            allowPrivilegeEscalation: {{ .securityContext.allowPrivilegeEscalation }}
            {{- else }}
            allowPrivilegeEscalation: {{ $.Values.app.securityContext.allowPrivilegeEscalation | default false }}
            {{- end }}
            {{- if .securityContext.capabilities }}
            capabilities:
              {{- if .securityContext.capabilities.add }}
              add:
                {{- range .securityContext.capabilities.add }}
                - {{ . }}
                {{- end }}
              {{- end }}
              {{- if .securityContext.capabilities.drop }}
              drop:
                {{- range .securityContext.capabilities.drop }}
                - {{ . }}
                {{- end }}
              {{- else }}
              drop:
                - ALL
              {{- end }}
            {{- else }}
            capabilities:
              {{- if $.Values.app.securityContext.capabilities }}
              {{- if $.Values.app.securityContext.capabilities.add }}
              add:
                {{- range $.Values.app.securityContext.capabilities.add }}
                - {{ . }}
                {{- end }}
              {{- end }}
              {{- if $.Values.app.securityContext.capabilities.drop }}
              drop:
                {{- range $.Values.app.securityContext.capabilities.drop }}
                - {{ . }}
                {{- end }}
              {{- else }}
              drop:
                - ALL
              {{- end }}
              {{- else }}
              drop:
                - ALL
              {{- end }}
            {{- end }}
            {{- if .securityContext.runAsNonRoot }}
            runAsNonRoot: {{ .securityContext.runAsNonRoot }}
            {{- else }}
            runAsNonRoot: {{ $.Values.app.securityContext.runAsNonRoot | default true }}
            {{- end }}
            {{- if .securityContext.runAsUser }}
            runAsUser: {{ .securityContext.runAsUser }}
            {{- else }}
            runAsUser: {{ .runAsUser | default 1000 }}
            {{- end }}
            {{- if .securityContext.readOnlyRootFilesystem }}
            readOnlyRootFilesystem: {{ .securityContext.readOnlyRootFilesystem }}
            {{- else }}
            readOnlyRootFilesystem: {{ $.Values.app.securityContext.readOnlyRootFilesystem | default true }}
            {{- end }}
            seccompProfile:
              type: RuntimeDefault
          {{- else }}
          securityContext:
            allowPrivilegeEscalation: {{ $.Values.app.securityContext.allowPrivilegeEscalation | default false }}
            capabilities:
              {{- if $.Values.app.securityContext.capabilities }}
              {{- if $.Values.app.securityContext.capabilities.add }}
              add:
                {{- range $.Values.app.securityContext.capabilities.add }}
                - {{ . }}
                {{- end }}
              {{- end }}
              {{- if $.Values.app.securityContext.capabilities.drop }}
              drop:
                {{- range $.Values.app.securityContext.capabilities.drop }}
                - {{ . }}
                {{- end }}
              {{- else }}
              drop:
                - ALL
              {{- end }}
              {{- else }}
              drop:
                - ALL
              {{- end }}
            runAsNonRoot: {{ $.Values.app.securityContext.runAsNonRoot | default true }}
            runAsUser: {{ .runAsUser | default 1000 }}
            readOnlyRootFilesystem: {{ $.Values.app.securityContext.readOnlyRootFilesystem | default true }}
            seccompProfile:
              type: RuntimeDefault
          {{- end }}
          volumeMounts:
            {{- if .volumeMounts }}
            {{- range .volumeMounts }}
            - name: {{ $.Values.app.name }}-{{ .name }}
              mountPath: {{ .mountPath }}
              {{- if .subPath }}
              subPath: {{ .subPath }}
              {{- end }}
              {{- if .readOnly }}
              readOnly: {{ .readOnly }}
              {{- end }}
            {{- end }}
            {{- end }}
            {{- if .volumes }}
            {{- range .volumes.emptyDir }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
            {{- end }}
            {{- range .volumes.configMap }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
              {{- if .subPath }}
              subPath: {{ .subPath }}
              {{- end }}
              {{- if .readOnly }}
              readOnly: {{ .readOnly }}
              {{- end }}
            {{- end }}
            {{- end }}
          {{- if .resources }}
          resources:
            {{- if .resources.requests }}
            requests:
              cpu: {{ .resources.requests.cpu | default "10m" }}
              memory: {{ .resources.requests.memory | default "16Mi" }}
            {{- end }}
            {{- if .resources.limits }}
            limits:
              cpu: {{ .resources.limits.cpu | default "50m" }}
              memory: {{ .resources.limits.memory | default "32Mi" }}
            {{- end }}
          {{- else }}
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 50m
              memory: 32Mi
          {{- end }}
        {{- end }}
        {{- end }}
      volumes:
        {{- range .Values.app.volumes.emptyDir }}
        - name: {{ $.Values.app.name }}-{{ .name }}
          emptyDir: {}
        {{- end }}
        {{- range .Values.app.volumes.tmpfs }}
        - name: {{ $.Values.app.name }}-{{ .name }}
          tmpfs:
            {{- if .options }}
            options: {{ .options }}
            {{- end }}
        {{- end }}
        {{- range .Values.app.volumes.configMap }}
        - name: {{ .name }}
          configMap:
            name: {{ .configMapName | default .name }}
        {{- end }}
        {{- range .Values.app.initContainers }}
        {{- if .volumes }}
        {{- range .volumes.emptyDir }}
        - name: {{ .name }}
          emptyDir: {}
        {{- end }}
        {{- range .volumes.configMap }}
        - name: {{ .name }}
          configMap:
            name: {{ .configMapName | default .name }}
        {{- end }}
        {{- end }}
        {{- end }}
        {{- range .Values.app.sidecars }}
        {{- if .volumes }}
        {{- range .volumes.emptyDir }}
        - name: {{ .name }}
          emptyDir: {}
        {{- end }}
        {{- range .volumes.configMap }}
        - name: {{ .name }}
          configMap:
            name: {{ .configMapName | default .name }}
        {{- end }}
        {{- end }}
        {{- end }}
        {{- range .Values.storage.longhorn.volumes }}
        - name: {{ $.Values.app.name }}-{{ .name }}
          persistentVolumeClaim:
            claimName: {{ $.Values.app.name }}-{{ .name }}
        {{- end }}
        {{- range .Values.storage.smb.volumes }}
        - name: {{ $.Values.app.name }}-{{ .name }}
          persistentVolumeClaim:
            claimName: {{ $.Values.app.name }}-{{ .name }}-pvc
            readOnly: {{ not (eq (.readOnly | toString) "false") }}
        {{- end }}
