---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Values.app.name }}
  namespace: {{ .Values.app.namespace | default .Values.app.name }}
spec:
  replicas: {{ .Values.app.replicas | default 2 }}
  strategy:
    {{- if and .Values.app.strategy (kindIs "map" .Values.app.strategy) (hasKey .Values.app.strategy "rollingUpdate") }}
    type: RollingUpdate
    rollingUpdate:
      maxSurge: {{ .Values.app.strategy.rollingUpdate.maxSurge | default "25%" }}
      maxUnavailable: {{ .Values.app.strategy.rollingUpdate.maxUnavailable | default "25%" }}
    {{- else if eq (toString .Values.app.strategy) "RollingUpdate" }}
    type: RollingUpdate
    rollingUpdate:
      maxSurge: "25%"
      maxUnavailable: "25%"
    {{- else }}
    type: Recreate
    {{- end }}
  selector:
    matchLabels:
      app: {{ .Values.app.name }}
  template:
    metadata:
      labels:
        app: {{ .Values.app.name }}
      {{- if .Values.app.podAnnotations }}
      annotations:
        {{- toYaml .Values.app.podAnnotations | nindent 8 }}
      {{- end }}
    spec:
      {{- if .Values.app.podAntiAffinity.enabled }}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - {{ .Values.app.name }}
                topologyKey: kubernetes.io/hostname
      {{- end }}
      securityContext:
        runAsNonRoot: {{ if (hasKey .Values.app.securityContext "runAsNonRoot") }}{{ .Values.app.securityContext.runAsNonRoot }}{{ else }}true{{ end }}
        runAsUser: {{ .Values.app.securityContext.runAsUser | default 1000 }}
        runAsGroup: {{ .Values.app.securityContext.runAsGroup | default 1000 }}
        fsGroup: {{ .Values.app.securityContext.fsGroup | default 1000 }}
        {{- if .Values.app.securityContext.fsGroupChangePolicy }}
        fsGroupChangePolicy: {{ .Values.app.securityContext.fsGroupChangePolicy }}
        {{- end }}
        seccompProfile:
          type: RuntimeDefault
      {{- if .Values.app.initContainers }}
      initContainers:
        {{- range .Values.app.initContainers }}
        - name: {{ .name }}
          image: {{ .image }}
          {{- if .command }}
          command: {{ .command | toYaml | nindent 12 }}
          {{- end }}
          {{- if .args }}
          args: {{ .args | toYaml | nindent 12 }}
          {{- end }}
          {{- if .env }}
          env:
            {{- range .env }}
            - name: {{ .name }}
              {{- if .value }}
              value: {{ .value | quote }}
              {{- else if .valueFrom }}
              valueFrom: {{ .valueFrom | toYaml | nindent 16 }}
              {{- end }}
            {{- end }}
          {{- end }}
          volumeMounts:
            {{- if .volumeMounts }}
            {{- range .volumeMounts }}
            - name: {{ $.Values.app.name }}-{{ .name }}
              mountPath: {{ .mountPath }}
              {{- if .subPath }}
              subPath: {{ .subPath }}
              {{- end }}
              {{- if .readOnly }}
              readOnly: {{ .readOnly }}
              {{- end }}
            {{- end }}
            {{- end }}
            {{- if .volumes }}
            {{- range .volumes.emptyDir }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
            {{- end }}
            {{- range .volumes.configMap }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
              {{- if .subPath }}
              subPath: {{ .subPath }}
              {{- end }}
              {{- if .readOnly }}
              readOnly: {{ .readOnly }}
              {{- end }}
            {{- end }}
            {{- end }}
          {{- if .securityContext }}
          securityContext:
            {{- if .securityContext.runAsUser }}
            runAsUser: {{ .securityContext.runAsUser }}
            {{- end }}
            {{- if .securityContext.runAsGroup }}
            runAsGroup: {{ .securityContext.runAsGroup }}
            {{- end }}
            {{- if .securityContext.runAsNonRoot }}
            runAsNonRoot: {{ .securityContext.runAsNonRoot }}
            {{- end }}
            {{- if .securityContext.readOnlyRootFilesystem }}
            readOnlyRootFilesystem: {{ .securityContext.readOnlyRootFilesystem }}
            {{- end }}
            {{- if .securityContext.allowPrivilegeEscalation }}
            allowPrivilegeEscalation: {{ .securityContext.allowPrivilegeEscalation }}
            {{- end }}
            {{- if .securityContext.capabilities }}
            capabilities:
              {{- if .securityContext.capabilities.add }}
              add:
                {{- range .securityContext.capabilities.add }}
                - {{ . }}
                {{- end }}
              {{- end }}
              {{- if .securityContext.capabilities.drop }}
              drop:
                {{- range .securityContext.capabilities.drop }}
                - {{ . }}
                {{- end }}
              {{- end }}
            {{- end }}
          {{- end }}
          {{- if .resources }}
          resources:
            {{- if .resources.requests }}
            requests:
              {{- if .resources.requests.cpu }}
              cpu: {{ .resources.requests.cpu }}
              {{- end }}
              {{- if .resources.requests.memory }}
              memory: {{ .resources.requests.memory }}
              {{- end }}
            {{- end }}
            {{- if .resources.limits }}
            limits:
              {{- if .resources.limits.cpu }}
              cpu: {{ .resources.limits.cpu }}
              {{- end }}
              {{- if .resources.limits.memory }}
              memory: {{ .resources.limits.memory }}
              {{- end }}
            {{- end }}
          {{- end }}
          {{- if .restartPolicy }}
          restartPolicy: {{ .restartPolicy }}
          {{- end }}
          {{- if .lifecycle }}
          lifecycle:
            {{- if .lifecycle.postStart }}
            postStart:
              {{- if .lifecycle.postStart.exec }}
              exec:
                command: {{ .lifecycle.postStart.exec.command | toYaml | nindent 16 }}
              {{- else if .lifecycle.postStart.httpGet }}
              httpGet: {{ .lifecycle.postStart.httpGet | toYaml | nindent 14 }}
              {{- else if .lifecycle.postStart.tcpSocket }}
              tcpSocket: {{ .lifecycle.postStart.tcpSocket | toYaml | nindent 14 }}
              {{- end }}
            {{- end }}
            {{- if .lifecycle.preStop }}
            preStop:
              {{- if .lifecycle.preStop.exec }}
              exec:
                command: {{ .lifecycle.preStop.exec.command | toYaml | nindent 16 }}
              {{- else if .lifecycle.preStop.httpGet }}
              httpGet: {{ .lifecycle.preStop.httpGet | toYaml | nindent 14 }}
              {{- else if .lifecycle.preStop.tcpSocket }}
              tcpSocket: {{ .lifecycle.preStop.tcpSocket | toYaml | nindent 14 }}
              {{- end }}
            {{- end }}
          {{- end }}
          {{- if .stopSignal }}
          stopSignal: {{ .stopSignal }}
          {{- end }}
        {{- end }}
      {{- end }}
      containers:
        - name: {{ .Values.app.container.name | default "main" }}
          image: {{ .Values.app.image | default "nginx:alpine" }}
          {{- if .Values.app.command }}
          command: {{ .Values.app.command | toYaml | nindent 12 }}
          {{- end }}
          {{- if .Values.app.args }}
          args: {{ .Values.app.args | toYaml | nindent 12 }}
          {{- end }}
          ports:
            - containerPort: {{ .Values.app.container.port | default 80 }}
            {{- if .Values.app.container.extraPorts }}
            {{- range .Values.app.container.extraPorts }}
            - containerPort: {{ .containerPort }}
              {{- if .name }}
              name: {{ .name }}
              {{- end }}
              protocol: {{ .protocol | default "TCP" }}
            {{- end }}
            {{- end }}
          {{- if .Values.app.container.env }}
          env:
            {{- range .Values.app.container.env }}
            - name: {{ .name }}
              {{- if .value }}
              value: {{ .value | quote }}
              {{- else if .valueFrom }}
              valueFrom: {{ .valueFrom | toYaml | nindent 16 }}
              {{- end }}
            {{- end }}
          {{- end }}
          securityContext:
            allowPrivilegeEscalation: {{ .Values.app.securityContext.allowPrivilegeEscalation | default false }}
            capabilities:
              {{- if .Values.app.securityContext.capabilities }}
              {{- if .Values.app.securityContext.capabilities.add }}
              add:
                {{- range .Values.app.securityContext.capabilities.add }}
                - {{ . }}
                {{- end }}
              {{- end }}
              {{- if .Values.app.securityContext.capabilities.drop }}
              drop:
                {{- range .Values.app.securityContext.capabilities.drop }}
                - {{ . }}
                {{- end }}
              {{- else }}
              drop:
                - ALL
              {{- end }}
              {{- else }}
              drop:
                - ALL
              {{- end }}
            runAsNonRoot: {{ if (hasKey .Values.app.securityContext "runAsNonRoot") }}{{ .Values.app.securityContext.runAsNonRoot }}{{ else }}true{{ end }}
            runAsUser: {{ .Values.app.securityContext.runAsUser | default 1000 }}
            readOnlyRootFilesystem: {{ if (hasKey .Values.app.securityContext "readOnlyRootFilesystem") }}{{ .Values.app.securityContext.readOnlyRootFilesystem }}{{ else }}true{{ end }}
            seccompProfile:
              type: RuntimeDefault
          volumeMounts:
            {{- if .Values.app.volumeMounts }}
            {{- range .Values.app.volumeMounts }}
            - name: {{ $.Values.app.name }}-{{ .name }}
              mountPath: {{ .mountPath }}
              {{- if .subPath }}
              subPath: {{ .subPath }}
              {{- end }}
              {{- if .readOnly }}
              readOnly: {{ .readOnly }}
              {{- end }}
            {{- end }}
            {{- end }}
            {{- if .Values.app.volumes.emptyDir }}
            {{- range .Values.app.volumes.emptyDir }}
            - name: {{ $.Values.app.name }}-{{ .name }}
              mountPath: {{ .mountPath }}
            {{- end }}
            {{- end }}
            {{- if .Values.app.volumes.tmpfs }}
            {{- range .Values.app.volumes.tmpfs }}
            - name: {{ $.Values.app.name }}-{{ .name }}
              mountPath: {{ .mountPath }}
            {{- end }}
            {{- end }}
            {{- if .Values.app.volumes.configMap }}
            {{- range .Values.app.volumes.configMap }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
              {{- if .subPath }}
              subPath: {{ .subPath }}
              {{- end }}
              {{- if .readOnly }}
              readOnly: {{ .readOnly }}
              {{- end }}
            {{- end }}
            {{- end }}
          resources:
            requests:
              cpu: {{ .Values.app.resources.requests.cpu | default "50m" }}
              memory: {{ .Values.app.resources.requests.memory | default "64Mi" }}
            limits:
              cpu: {{ .Values.app.resources.limits.cpu | default "100m" }}
              memory: {{ .Values.app.resources.limits.memory | default "128Mi" }}
          {{- if .Values.app.lifecycle }}
          lifecycle:
            {{- if .Values.app.lifecycle.postStart }}
            postStart:
              {{- if .Values.app.lifecycle.postStart.exec }}
              exec:
                command: {{ .Values.app.lifecycle.postStart.exec.command | toYaml | nindent 16 }}
              {{- else if .Values.app.lifecycle.postStart.httpGet }}
              httpGet: {{ .Values.app.lifecycle.postStart.httpGet | toYaml | nindent 14 }}
              {{- else if .Values.app.lifecycle.postStart.tcpSocket }}
              tcpSocket: {{ .Values.app.lifecycle.postStart.tcpSocket | toYaml | nindent 14 }}
              {{- end }}
            {{- end }}
            {{- if .Values.app.lifecycle.preStop }}
            preStop:
              {{- if .Values.app.lifecycle.preStop.exec }}
              exec:
                command: {{ .Values.app.lifecycle.preStop.exec.command | toYaml | nindent 16 }}
              {{- else if .Values.app.lifecycle.preStop.httpGet }}
              httpGet: {{ .Values.app.lifecycle.preStop.httpGet | toYaml | nindent 14 }}
              {{- else if .Values.app.lifecycle.preStop.tcpSocket }}
              tcpSocket: {{ .Values.app.lifecycle.preStop.tcpSocket | toYaml | nindent 14 }}
              {{- end }}
            {{- end }}
          {{- end }}
          {{- if and .Values.app.healthChecks .Values.app.healthChecks.livenessProbe (eq .Values.app.healthChecks.livenessProbe.enabled true) }}
          livenessProbe:
            {{- if .Values.app.healthChecks.livenessProbe.httpGet }}
            httpGet: {{ .Values.app.healthChecks.livenessProbe.httpGet | toYaml | nindent 14 }}
            {{- else if .Values.app.healthChecks.livenessProbe.exec }}
            exec:
              command: {{ .Values.app.healthChecks.livenessProbe.exec.command | toYaml | nindent 16 }}
            {{- else if .Values.app.healthChecks.livenessProbe.tcpSocket }}
            tcpSocket: {{ .Values.app.healthChecks.livenessProbe.tcpSocket | toYaml | nindent 14 }}
            {{- end }}
            {{- if .Values.app.healthChecks.livenessProbe.initialDelaySeconds }}
            initialDelaySeconds: {{ .Values.app.healthChecks.livenessProbe.initialDelaySeconds }}
            {{- end }}
            {{- if .Values.app.healthChecks.livenessProbe.periodSeconds }}
            periodSeconds: {{ .Values.app.healthChecks.livenessProbe.periodSeconds }}
            {{- end }}
            {{- if .Values.app.healthChecks.livenessProbe.timeoutSeconds }}
            timeoutSeconds: {{ .Values.app.healthChecks.livenessProbe.timeoutSeconds }}
            {{- end }}
            {{- if .Values.app.healthChecks.livenessProbe.failureThreshold }}
            failureThreshold: {{ .Values.app.healthChecks.livenessProbe.failureThreshold }}
            {{- end }}
            {{- if .Values.app.healthChecks.livenessProbe.successThreshold }}
            successThreshold: {{ .Values.app.healthChecks.livenessProbe.successThreshold }}
            {{- end }}
          {{- end }}
          {{- if and .Values.app.healthChecks .Values.app.healthChecks.readinessProbe (eq .Values.app.healthChecks.readinessProbe.enabled true) }}
          readinessProbe:
            {{- if .Values.app.healthChecks.readinessProbe.httpGet }}
            httpGet: {{ .Values.app.healthChecks.readinessProbe.httpGet | toYaml | nindent 14 }}
            {{- else if .Values.app.healthChecks.readinessProbe.exec }}
            exec:
              command: {{ .Values.app.healthChecks.readinessProbe.exec.command | toYaml | nindent 16 }}
            {{- else if .Values.app.healthChecks.readinessProbe.tcpSocket }}
            tcpSocket: {{ .Values.app.healthChecks.readinessProbe.tcpSocket | toYaml | nindent 14 }}
            {{- end }}
            {{- if .Values.app.healthChecks.readinessProbe.initialDelaySeconds }}
            initialDelaySeconds: {{ .Values.app.healthChecks.readinessProbe.initialDelaySeconds }}
            {{- end }}
            {{- if .Values.app.healthChecks.readinessProbe.periodSeconds }}
            periodSeconds: {{ .Values.app.healthChecks.readinessProbe.periodSeconds }}
            {{- end }}
            {{- if .Values.app.healthChecks.readinessProbe.timeoutSeconds }}
            timeoutSeconds: {{ .Values.app.healthChecks.readinessProbe.timeoutSeconds }}
            {{- end }}
            {{- if .Values.app.healthChecks.readinessProbe.failureThreshold }}
            failureThreshold: {{ .Values.app.healthChecks.readinessProbe.failureThreshold }}
            {{- end }}
            {{- if .Values.app.healthChecks.readinessProbe.successThreshold }}
            successThreshold: {{ .Values.app.healthChecks.readinessProbe.successThreshold }}
            {{- end }}
          {{- end }}
          {{- if and .Values.app.healthChecks .Values.app.healthChecks.startupProbe (eq .Values.app.healthChecks.startupProbe.enabled true) }}
          startupProbe:
            {{- if .Values.app.healthChecks.startupProbe.httpGet }}
            httpGet: {{ .Values.app.healthChecks.startupProbe.httpGet | toYaml | nindent 14 }}
            {{- else if .Values.app.healthChecks.startupProbe.exec }}
            exec:
              command: {{ .Values.app.healthChecks.startupProbe.exec.command | toYaml | nindent 16 }}
            {{- else if .Values.app.healthChecks.startupProbe.tcpSocket }}
            tcpSocket: {{ .Values.app.healthChecks.startupProbe.tcpSocket | toYaml | nindent 14 }}
            {{- end }}
            {{- if .Values.app.healthChecks.startupProbe.initialDelaySeconds }}
            initialDelaySeconds: {{ .Values.app.healthChecks.startupProbe.initialDelaySeconds }}
            {{- end }}
            {{- if .Values.app.healthChecks.startupProbe.periodSeconds }}
            periodSeconds: {{ .Values.app.healthChecks.startupProbe.periodSeconds }}
            {{- end }}
            {{- if .Values.app.healthChecks.startupProbe.timeoutSeconds }}
            timeoutSeconds: {{ .Values.app.healthChecks.startupProbe.timeoutSeconds }}
            {{- end }}
            {{- if .Values.app.healthChecks.startupProbe.failureThreshold }}
            failureThreshold: {{ .Values.app.healthChecks.startupProbe.failureThreshold }}
            {{- end }}
            {{- if .Values.app.healthChecks.startupProbe.successThreshold }}
            successThreshold: {{ .Values.app.healthChecks.startupProbe.successThreshold }}
            {{- end }}
          {{- end }}
        {{- if .Values.app.sidecars }}
        {{- range .Values.app.sidecars }}
        - name: {{ .name }}
          image: {{ .image }}
          {{- if .command }}
          command: {{ .command | toYaml | nindent 12 }}
          {{- end }}
          {{- if .args }}
          args: {{ .args | toYaml | nindent 12 }}
          {{- end }}
          {{- if .ports }}
          ports:
            {{- range .ports }}
            - containerPort: {{ .containerPort }}
              {{- if .name }}
              name: {{ .name }}
              {{- end }}
              protocol: {{ .protocol | default "TCP" }}
            {{- end }}
          {{- end }}
          {{- if .env }}
          env:
            {{- range .env }}
            - name: {{ .name }}
              {{- if .value }}
              value: {{ .value | quote }}
              {{- else if .valueFrom }}
              valueFrom: {{ .valueFrom | toYaml | nindent 16 }}
              {{- end }}
            {{- end }}
          {{- end }}
          {{- if .securityContext }}
          securityContext:
            {{- if .securityContext.allowPrivilegeEscalation }}
            allowPrivilegeEscalation: {{ .securityContext.allowPrivilegeEscalation }}
            {{- else }}
            allowPrivilegeEscalation: {{ $.Values.app.securityContext.allowPrivilegeEscalation | default false }}
            {{- end }}
            {{- if .securityContext.capabilities }}
            capabilities:
              {{- if .securityContext.capabilities.add }}
              add:
                {{- range .securityContext.capabilities.add }}
                - {{ . }}
                {{- end }}
              {{- end }}
              {{- if .securityContext.capabilities.drop }}
              drop:
                {{- range .securityContext.capabilities.drop }}
                - {{ . }}
                {{- end }}
              {{- else }}
              drop:
                - ALL
              {{- end }}
            {{- else }}
            capabilities:
              {{- if $.Values.app.securityContext.capabilities }}
              {{- if $.Values.app.securityContext.capabilities.add }}
              add:
                {{- range $.Values.app.securityContext.capabilities.add }}
                - {{ . }}
                {{- end }}
              {{- end }}
              {{- if $.Values.app.securityContext.capabilities.drop }}
              drop:
                {{- range $.Values.app.securityContext.capabilities.drop }}
                - {{ . }}
                {{- end }}
              {{- else }}
              drop:
                - ALL
              {{- end }}
              {{- else }}
              drop:
                - ALL
              {{- end }}
            {{- end }}
            {{- if .securityContext.runAsNonRoot }}
            runAsNonRoot: {{ .securityContext.runAsNonRoot }}
            {{- else }}
            runAsNonRoot: {{ if (hasKey $.Values.app.securityContext "runAsNonRoot") }}{{ $.Values.app.securityContext.runAsNonRoot }}{{ else }}true{{ end }}
            {{- end }}
            {{- if .securityContext.runAsUser }}
            runAsUser: {{ .securityContext.runAsUser }}
            {{- else }}
            runAsUser: {{ .runAsUser | default 1000 }}
            {{- end }}
            {{- if .securityContext.readOnlyRootFilesystem }}
            readOnlyRootFilesystem: {{ .securityContext.readOnlyRootFilesystem }}
            {{- else }}
            readOnlyRootFilesystem: {{ if (hasKey $.Values.app.securityContext "readOnlyRootFilesystem") }}{{ $.Values.app.securityContext.readOnlyRootFilesystem }}{{ else }}true{{ end }}
            {{- end }}
            seccompProfile:
              type: RuntimeDefault
          {{- else }}
          securityContext:
            allowPrivilegeEscalation: {{ $.Values.app.securityContext.allowPrivilegeEscalation | default false }}
            capabilities:
              {{- if $.Values.app.securityContext.capabilities }}
              {{- if $.Values.app.securityContext.capabilities.add }}
              add:
                {{- range $.Values.app.securityContext.capabilities.add }}
                - {{ . }}
                {{- end }}
              {{- end }}
              {{- if $.Values.app.securityContext.capabilities.drop }}
              drop:
                {{- range $.Values.app.securityContext.capabilities.drop }}
                - {{ . }}
                {{- end }}
              {{- else }}
              drop:
                - ALL
              {{- end }}
              {{- else }}
              drop:
                - ALL
              {{- end }}
            runAsNonRoot: {{ if (hasKey $.Values.app.securityContext "runAsNonRoot") }}{{ $.Values.app.securityContext.runAsNonRoot }}{{ else }}true{{ end }}
            runAsUser: {{ .runAsUser | default 1000 }}
            readOnlyRootFilesystem: {{ if (hasKey $.Values.app.securityContext "readOnlyRootFilesystem") }}{{ $.Values.app.securityContext.readOnlyRootFilesystem }}{{ else }}true{{ end }}
            seccompProfile:
              type: RuntimeDefault
          {{- end }}
          volumeMounts:
            {{- if .volumeMounts }}
            {{- range .volumeMounts }}
            - name: {{ $.Values.app.name }}-{{ .name }}
              mountPath: {{ .mountPath }}
              {{- if .subPath }}
              subPath: {{ .subPath }}
              {{- end }}
              {{- if .readOnly }}
              readOnly: {{ .readOnly }}
              {{- end }}
            {{- end }}
            {{- end }}
            {{- if .volumes }}
            {{- range .volumes.emptyDir }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
            {{- end }}
            {{- range .volumes.configMap }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
              {{- if .subPath }}
              subPath: {{ .subPath }}
              {{- end }}
              {{- if .readOnly }}
              readOnly: {{ .readOnly }}
              {{- end }}
            {{- end }}
            {{- end }}
          {{- if .resources }}
          resources:
            {{- if .resources.requests }}
            requests:
              cpu: {{ .resources.requests.cpu | default "10m" }}
              memory: {{ .resources.requests.memory | default "16Mi" }}
            {{- end }}
            {{- if .resources.limits }}
            limits:
              cpu: {{ .resources.limits.cpu | default "50m" }}
              memory: {{ .resources.limits.memory | default "32Mi" }}
            {{- end }}
          {{- else }}
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 50m
              memory: 32Mi
          {{- end }}
          {{- if .lifecycle }}
          lifecycle:
            {{- if .lifecycle.postStart }}
            postStart:
              {{- if .lifecycle.postStart.exec }}
              exec:
                command: {{ .lifecycle.postStart.exec.command | toYaml | nindent 16 }}
              {{- else if .lifecycle.postStart.httpGet }}
              httpGet: {{ .lifecycle.postStart.httpGet | toYaml | nindent 14 }}
              {{- else if .lifecycle.postStart.tcpSocket }}
              tcpSocket: {{ .lifecycle.postStart.tcpSocket | toYaml | nindent 14 }}
              {{- end }}
            {{- end }}
            {{- if .lifecycle.preStop }}
            preStop:
              {{- if .lifecycle.preStop.exec }}
              exec:
                command: {{ .lifecycle.preStop.exec.command | toYaml | nindent 16 }}
              {{- else if .lifecycle.preStop.httpGet }}
              httpGet: {{ .lifecycle.preStop.httpGet | toYaml | nindent 14 }}
              {{- else if .lifecycle.preStop.tcpSocket }}
              tcpSocket: {{ .lifecycle.preStop.tcpSocket | toYaml | nindent 14 }}
              {{- end }}
            {{- end }}
          {{- end }}
          {{- if and .healthChecks .healthChecks.livenessProbe (eq .healthChecks.livenessProbe.enabled true) }}
          livenessProbe:
            {{- if .healthChecks.livenessProbe.httpGet }}
            httpGet: {{ .healthChecks.livenessProbe.httpGet | toYaml | nindent 14 }}
            {{- else if .healthChecks.livenessProbe.exec }}
            exec:
              command: {{ .healthChecks.livenessProbe.exec.command | toYaml | nindent 16 }}
            {{- else if .healthChecks.livenessProbe.tcpSocket }}
            tcpSocket: {{ .healthChecks.livenessProbe.tcpSocket | toYaml | nindent 14 }}
            {{- end }}
            {{- if .healthChecks.livenessProbe.initialDelaySeconds }}
            initialDelaySeconds: {{ .healthChecks.livenessProbe.initialDelaySeconds }}
            {{- end }}
            {{- if .healthChecks.livenessProbe.periodSeconds }}
            periodSeconds: {{ .healthChecks.livenessProbe.periodSeconds }}
            {{- end }}
            {{- if .healthChecks.livenessProbe.timeoutSeconds }}
            timeoutSeconds: {{ .healthChecks.livenessProbe.timeoutSeconds }}
            {{- end }}
            {{- if .healthChecks.livenessProbe.failureThreshold }}
            failureThreshold: {{ .healthChecks.livenessProbe.failureThreshold }}
            {{- end }}
            {{- if .healthChecks.livenessProbe.successThreshold }}
            successThreshold: {{ .healthChecks.livenessProbe.successThreshold }}
            {{- end }}
          {{- end }}
          {{- if and .healthChecks .healthChecks.readinessProbe (eq .healthChecks.readinessProbe.enabled true) }}
          readinessProbe:
            {{- if .healthChecks.readinessProbe.httpGet }}
            httpGet: {{ .healthChecks.readinessProbe.httpGet | toYaml | nindent 14 }}
            {{- else if .healthChecks.readinessProbe.exec }}
            exec:
              command: {{ .healthChecks.readinessProbe.exec.command | toYaml | nindent 16 }}
            {{- else if .healthChecks.readinessProbe.tcpSocket }}
            tcpSocket: {{ .healthChecks.readinessProbe.tcpSocket | toYaml | nindent 14 }}
            {{- end }}
            {{- if .healthChecks.readinessProbe.initialDelaySeconds }}
            initialDelaySeconds: {{ .healthChecks.readinessProbe.initialDelaySeconds }}
            {{- end }}
            {{- if .healthChecks.readinessProbe.periodSeconds }}
            periodSeconds: {{ .healthChecks.readinessProbe.periodSeconds }}
            {{- end }}
            {{- if .healthChecks.readinessProbe.timeoutSeconds }}
            timeoutSeconds: {{ .healthChecks.readinessProbe.timeoutSeconds }}
            {{- end }}
            {{- if .healthChecks.readinessProbe.failureThreshold }}
            failureThreshold: {{ .healthChecks.readinessProbe.failureThreshold }}
            {{- end }}
            {{- if .healthChecks.readinessProbe.successThreshold }}
            successThreshold: {{ .healthChecks.readinessProbe.successThreshold }}
            {{- end }}
          {{- end }}
          {{- if and .healthChecks .healthChecks.startupProbe (eq .healthChecks.startupProbe.enabled true) }}
          startupProbe:
            {{- if .healthChecks.startupProbe.httpGet }}
            httpGet: {{ .healthChecks.startupProbe.httpGet | toYaml | nindent 14 }}
            {{- else if .healthChecks.startupProbe.exec }}
            exec:
              command: {{ .healthChecks.startupProbe.exec.command | toYaml | nindent 16 }}
            {{- else if .healthChecks.startupProbe.tcpSocket }}
            tcpSocket: {{ .healthChecks.startupProbe.tcpSocket | toYaml | nindent 14 }}
            {{- end }}
            {{- if .healthChecks.startupProbe.initialDelaySeconds }}
            initialDelaySeconds: {{ .healthChecks.startupProbe.initialDelaySeconds }}
            {{- end }}
            {{- if .healthChecks.startupProbe.periodSeconds }}
            periodSeconds: {{ .healthChecks.startupProbe.periodSeconds }}
            {{- end }}
            {{- if .healthChecks.startupProbe.timeoutSeconds }}
            timeoutSeconds: {{ .healthChecks.startupProbe.timeoutSeconds }}
            {{- end }}
            {{- if .healthChecks.startupProbe.failureThreshold }}
            failureThreshold: {{ .healthChecks.startupProbe.failureThreshold }}
            {{- end }}
            {{- if .healthChecks.startupProbe.successThreshold }}
            successThreshold: {{ .healthChecks.startupProbe.successThreshold }}
            {{- end }}
          {{- end }}
        {{- end }}
        {{- end }}
      volumes:
        {{- /*
          Volume Deduplication Strategy:
          Build a complete set of all volume names BEFORE creating any volumes.
          This prevents duplicates across app.volumes, initContainers, and sidecars.
          First occurrence wins - volume is created with the first definition found.
        */}}
        {{- $createdVolumes := dict }}
        {{- /* 1. App-level emptyDir volumes (prefixed with app.name) */}}
        {{- range .Values.app.volumes.emptyDir }}
        {{- $volName := printf "%s-%s" $.Values.app.name .name }}
        {{- if not (hasKey $createdVolumes $volName) }}
        {{- $_ := set $createdVolumes $volName true }}
        - name: {{ $volName }}
          emptyDir: {}
        {{- end }}
        {{- end }}
        {{- /* 2. App-level tmpfs volumes (prefixed with app.name) */}}
        {{- range .Values.app.volumes.tmpfs }}
        {{- $volName := printf "%s-%s" $.Values.app.name .name }}
        {{- if not (hasKey $createdVolumes $volName) }}
        {{- $_ := set $createdVolumes $volName true }}
        - name: {{ $volName }}
          tmpfs:
            {{- if .options }}
            options: {{ .options }}
            {{- end }}
        {{- end }}
        {{- end }}
        {{- /* 3. App-level configMap volumes (NOT prefixed) */}}
        {{- range .Values.app.volumes.configMap }}
        {{- if not (hasKey $createdVolumes .name) }}
        {{- $_ := set $createdVolumes .name true }}
        - name: {{ .name }}
          configMap:
            name: {{ .configMapName | default .name }}
        {{- end }}
        {{- end }}
        {{- /* 4. initContainer volumes (emptyDir and configMap, NOT prefixed) */}}
        {{- range .Values.app.initContainers }}
        {{- if .volumes }}
        {{- range .volumes.emptyDir }}
        {{- if not (hasKey $createdVolumes .name) }}
        {{- $_ := set $createdVolumes .name true }}
        - name: {{ .name }}
          emptyDir: {}
        {{- end }}
        {{- end }}
        {{- range .volumes.configMap }}
        {{- if not (hasKey $createdVolumes .name) }}
        {{- $_ := set $createdVolumes .name true }}
        - name: {{ .name }}
          configMap:
            name: {{ .configMapName | default .name }}
        {{- end }}
        {{- end }}
        {{- end }}
        {{- end }}
        {{- /* 5. Sidecar volumes (emptyDir and configMap, NOT prefixed) */}}
        {{- range .Values.app.sidecars }}
        {{- if .volumes }}
        {{- range .volumes.emptyDir }}
        {{- if not (hasKey $createdVolumes .name) }}
        {{- $_ := set $createdVolumes .name true }}
        - name: {{ .name }}
          emptyDir: {}
        {{- end }}
        {{- end }}
        {{- range .volumes.configMap }}
        {{- if not (hasKey $createdVolumes .name) }}
        {{- $_ := set $createdVolumes .name true }}
        - name: {{ .name }}
          configMap:
            name: {{ .configMapName | default .name }}
        {{- end }}
        {{- end }}
        {{- end }}
        {{- end }}
        {{- range .Values.storage.longhorn.volumes }}
        - name: {{ $.Values.app.name }}-{{ .name }}
          persistentVolumeClaim:
            claimName: {{ $.Values.app.name }}-{{ .name }}
        {{- end }}
        {{- range .Values.storage.smb.volumes }}
        - name: {{ $.Values.app.name }}-{{ .name }}
          persistentVolumeClaim:
            claimName: {{ $.Values.app.name }}-{{ .name }}-pvc
            readOnly: {{ not (eq (.readOnly | toString) "false") }}
        {{- end }}
