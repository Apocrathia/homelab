---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Values.app.name }}
  namespace: {{ .Values.app.namespace | default .Values.app.name }}
spec:
  replicas: {{ .Values.app.replicas | default 2 }}
  selector:
    matchLabels:
      app: {{ .Values.app.name }}
  template:
    metadata:
      labels:
        app: {{ .Values.app.name }}
    spec:
      {{- if .Values.app.podAntiAffinity.enabled }}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - {{ .Values.app.name }}
                topologyKey: kubernetes.io/hostname
      {{- end }}
      securityContext:
        runAsNonRoot: true
        runAsUser: {{ .Values.app.securityContext.runAsUser | default 1000 }}
        runAsGroup: {{ .Values.app.securityContext.runAsGroup | default 1000 }}
        fsGroup: {{ .Values.app.securityContext.fsGroup | default 1000 }}
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: {{ .Values.app.container.name | default "main" }}
          image: {{ .Values.app.image | default "nginx:alpine" }}
          {{- if .Values.app.command }}
          command: {{ .Values.app.command | toYaml | nindent 12 }}
          {{- end }}
          {{- if .Values.app.args }}
          args: {{ .Values.app.args | toYaml | nindent 12 }}
          {{- end }}
          ports:
            - containerPort: {{ .Values.app.container.port | default 80 }}
            {{- if .Values.app.container.extraPorts }}
            {{- range .Values.app.container.extraPorts }}
            - containerPort: {{ .containerPort }}
              {{- if .name }}
              name: {{ .name }}
              {{- end }}
              protocol: {{ .protocol | default "TCP" }}
            {{- end }}
            {{- end }}
          {{- if .Values.app.container.env }}
          env:
            {{- range .Values.app.container.env }}
            - name: {{ .name }}
              {{- if .value }}
              value: {{ .value | quote }}
              {{- else if .valueFrom }}
              valueFrom: {{ .valueFrom | toYaml | nindent 16 }}
              {{- end }}
            {{- end }}
          {{- end }}
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            runAsNonRoot: true
            runAsUser: {{ .Values.app.securityContext.runAsUser | default 1000 }}
            readOnlyRootFilesystem: {{ .Values.app.securityContext.readOnlyRootFilesystem | default true }}
            seccompProfile:
              type: RuntimeDefault
          volumeMounts:
            {{- range .Values.app.volumes.emptyDir }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
            {{- end }}
            {{- range .Values.app.volumes.configMap }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
              {{- if .subPath }}
              subPath: {{ .subPath }}
              {{- end }}
              {{- if .readOnly }}
              readOnly: {{ .readOnly }}
              {{- end }}
            {{- end }}
            {{- if .Values.storage.longhorn.enabled }}
            - name: app-data
              mountPath: {{ .Values.storage.longhorn.mountPath | default "/app" }}
            {{- end }}
            {{- if .Values.storage.smb.enabled }}
            - name: smb-files
              mountPath: {{ .Values.storage.smb.mountPath | default "/usr/share/nginx/html" }}
              readOnly: true
            {{- end }}
          resources:
            requests:
              cpu: {{ .Values.app.resources.requests.cpu | default "50m" }}
              memory: {{ .Values.app.resources.requests.memory | default "64Mi" }}
            limits:
              cpu: {{ .Values.app.resources.limits.cpu | default "100m" }}
              memory: {{ .Values.app.resources.limits.memory | default "128Mi" }}
        {{- if .Values.app.sidecars }}
        {{- range .Values.app.sidecars }}
        - name: {{ .name }}
          image: {{ .image }}
          {{- if .command }}
          command: {{ .command | toYaml | nindent 12 }}
          {{- end }}
          {{- if .args }}
          args: {{ .args | toYaml | nindent 12 }}
          {{- end }}
          {{- if .ports }}
          ports:
            {{- range .ports }}
            - containerPort: {{ .containerPort }}
              {{- if .name }}
              name: {{ .name }}
              {{- end }}
              protocol: {{ .protocol | default "TCP" }}
            {{- end }}
          {{- end }}
          {{- if .env }}
          env:
            {{- range .env }}
            - name: {{ .name }}
              {{- if .value }}
              value: {{ .value | quote }}
              {{- else if .valueFrom }}
              valueFrom: {{ .valueFrom | toYaml | nindent 16 }}
              {{- end }}
            {{- end }}
          {{- end }}
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            runAsNonRoot: true
            runAsUser: {{ .runAsUser | default 1000 }}
            readOnlyRootFilesystem: {{ $.Values.app.securityContext.readOnlyRootFilesystem | default true }}
            seccompProfile:
              type: RuntimeDefault
          {{- if .volumeMounts }}
          volumeMounts:
            {{- range .volumeMounts }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
              {{- if .subPath }}
              subPath: {{ .subPath }}
              {{- end }}
              {{- if .readOnly }}
              readOnly: {{ .readOnly }}
              {{- end }}
            {{- end }}
          {{- end }}
          {{- if .resources }}
          resources:
            {{- if .resources.requests }}
            requests:
              cpu: {{ .resources.requests.cpu | default "10m" }}
              memory: {{ .resources.requests.memory | default "16Mi" }}
            {{- end }}
            {{- if .resources.limits }}
            limits:
              cpu: {{ .resources.limits.cpu | default "50m" }}
              memory: {{ .resources.limits.memory | default "32Mi" }}
            {{- end }}
          {{- else }}
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 50m
              memory: 32Mi
          {{- end }}
        {{- end }}
        {{- end }}
      volumes:
        {{- range .Values.app.volumes.emptyDir }}
        - name: {{ .name }}
          emptyDir: {}
        {{- end }}
        {{- range .Values.app.volumes.configMap }}
        - name: {{ .name }}
          configMap:
            name: {{ .configMapName | default .name }}
        {{- end }}
        {{- if .Values.storage.longhorn.enabled }}
        - name: app-data
          persistentVolumeClaim:
            claimName: {{ .Values.app.name }}-data
        {{- end }}
        {{- if .Values.storage.smb.enabled }}
        - name: smb-files
          persistentVolumeClaim:
            claimName: {{ .Values.app.name }}-smb-pvc
            readOnly: true
        {{- end }}
