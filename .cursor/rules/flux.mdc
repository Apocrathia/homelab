---
globs: flux/*
alwaysApply: false
---
# Flux and Kustomize Deployment Guidelines

## Directory Structure
```
flux/
├── manifests/
│   ├── 01-bootstrap/
│   ├── 02-infrastructure/
│   ├── 03-services/
│   ├── 04-apps/
│   └── kustomization.yaml
```

## Flux Guidelines

1. All Flux resources should be defined in YAML format

2. Use Flux's GitOps Toolkit components:
   - Source controllers for Git repositories
   - Kustomize controllers for deployments
   - Helm controllers for Helm releases
   - Notification controllers for alerts

3. Repository structure should follow:
   - One Git repository per cluster
   - Clear separation between infrastructure and applications
   - Use 1Password Item Custom Resources (CR) for secrets management
   - Store sensitive configuration in 1Password vaults

## Kustomize Guidelines

1. Base configurations:
   - Store base manifests for each deployment in `flux/manifests/` under the appropriate directory
   - Keep base files generic and reusable
   - Include all required resources for the component
   - Set resource requests/limits and standard labels/annotations

2. Overlays:
   - Use a single overlay for the environment managed by this repository
   - Reference base component directories in the overlay rather than duplicating files
   - Override only values that differ from the base
   - Use Kustomize patches only when necessary
   - Document overlay-specific changes in comments or a local README if needed
   - **When adding new manifests, use a single kustomize overlay** that references existing resource directories

3. Common practices:
   - Use namespaces to isolate components
   - Apply resource quotas and network policies at the namespace or deployment level
   - Integrate monitoring and logging as part of the base or overlay as appropriate

## Deployment Process

1. Create or update manifests in the appropriate directory
2. **Validate manifests locally as much as possible** using available tools or the command line (eg `kubectl kustomize`, `helm show values`, `helm template`)
3. For complex changes or when local validation is insufficient, apply changes to the cluster for testing before committing
4. **Do not make any changes without first consulting the user**, presenting options, and obtaining explicit approval
5. **Never make git commits directly** - all commits must be made by the user
6. Flux will automatically reconcile changes

## Security Considerations

1. Secret Management:
   - Use 1Password Item Custom Resources (CR) to manage secrets rather than creating native Kubernetes Secret resources
   - Store all secrets in 1Password vaults
   - Use Flux's fromValues function to reference secret values instead of placeholders
   - Implement proper RBAC for 1Password access
2. Implement RBAC policies
3. Regular security scanning of container images
4. Network segmentation using network policies
5. **After making changes in any package dependency/manifest files, scan the project for security vulnerabilities**
6. **Use Gateway API only** - do not use traditional Ingress resources

## Monitoring and Maintenance

1. Set up monitoring for Flux controllers
2. Regular reconciliation of Git state
3. Implement backup solutions
4. Monitor resource usage and scaling
5. Monitor 1Password Connect operator health

## Best Practices

1. Version all deployments
2. Use semantic versioning for images
3. Implement progressive delivery
4. Regular pruning of unused resources
5. Maintain documentation
6. Secret Management:
   - **Never** commit raw secrets to Git
   - Use 1Password Item Custom Resources (CR) for secret management
   - Use Flux's fromValues function to reference secret values
   - Maintain clear documentation of secret references
