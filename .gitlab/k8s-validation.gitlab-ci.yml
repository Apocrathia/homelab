---
# Simple Kubernetes Validation using Flux CLI
# This uses Flux's built-in validation commands for GitOps workflows

.flux-validation:
  stage: validate
  image: ubuntu:24.04
  environment:
    name: homelab
  variables:
    FLUX_VERSION: "2.4.0"
    KUBECTL_VERSION: "1.31.0"
  before_script:
    # Install required tools
    - apt-get update && apt-get install -y curl jq ca-certificates
    # Install kubectl
    - curl -LO "https://dl.k8s.io/release/v${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
    - chmod +x kubectl && mv kubectl /usr/local/bin/
    # Install flux CLI
    - curl -s https://fluxcd.io/install.sh | FLUX_VERSION=${FLUX_VERSION} bash
    - mv /root/.local/bin/flux /usr/local/bin/ || mv flux /usr/local/bin/
    # Verify cluster connection
    - kubectl cluster-info
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true
  tags:
    - kubernetes

# Validate manifests can be built and are valid
flux-validate:
  extends: .flux-validation
  script:
    - |
      echo "=== Flux Validation ==="

      # Initialize results
      VALIDATION_RESULT="âœ… **Flux Validation Results**\n\n"
      BUILD_SUCCESS=true

      # Check if Flux can build all kustomizations
      echo "1. Building and validating Flux kustomizations..."
      if flux build kustomization manifests --path="./flux/manifests" --dry-run > /tmp/flux-build.log 2>&1; then
        VALIDATION_RESULT+="âœ… **Main kustomization builds successfully**\n"
        echo "âœ… Main kustomization builds successfully"
      else
        VALIDATION_RESULT+="âŒ **Main kustomization build failed**\n\`\`\`\n$(cat /tmp/flux-build.log)\n\`\`\`\n"
        BUILD_SUCCESS=false
        echo "âŒ Main kustomization build failed"
      fi

      # Validate individual layers
      for layer in bootstrap infrastructure services apps; do
        if [ -f "flux/manifests/0*-${layer}/flux-kustomization.yaml" ]; then
          echo "Validating ${layer} layer..."
          if flux build kustomization ${layer} --path="./flux/manifests" --dry-run > /tmp/flux-${layer}.log 2>&1; then
            VALIDATION_RESULT+="âœ… **${layer} layer**: builds successfully\n"
            echo "âœ… ${layer} layer builds successfully"
          else
            VALIDATION_RESULT+="âŒ **${layer} layer**: build failed\n\`\`\`\n$(cat /tmp/flux-${layer}.log)\n\`\`\`\n"
            BUILD_SUCCESS=false
            echo "âŒ ${layer} layer build failed"
          fi
        fi
      done

      # Show what would change if applied
      echo "2. Checking what would change..."
      if flux diff kustomization manifests --path="./flux/manifests" > /tmp/flux-diff.log 2>&1; then
        DIFF_OUTPUT=$(cat /tmp/flux-diff.log)
        if [ -n "$DIFF_OUTPUT" ] && [ "$DIFF_OUTPUT" != "no changes" ]; then
          VALIDATION_RESULT+="\nðŸ“‹ **Changes Preview**:\n\`\`\`diff\n${DIFF_OUTPUT}\n\`\`\`\n"
        else
          VALIDATION_RESULT+="\nðŸ“‹ **Changes Preview**: No changes detected\n"
        fi
      else
        VALIDATION_RESULT+="\nâš ï¸ **Changes Preview**: Could not generate diff\n"
      fi

      # Set overall result
      if [ "$BUILD_SUCCESS" = true ]; then
        VALIDATION_RESULT="âœ… **Kubernetes Validation Passed** ðŸŽ‰\n\n${VALIDATION_RESULT}"
        echo "âœ… Flux validation completed successfully"
      else
        VALIDATION_RESULT="âŒ **Kubernetes Validation Failed** âš ï¸\n\n${VALIDATION_RESULT}"
        echo "âŒ Flux validation failed"
      fi

      # Save results for posting to MR
      echo -e "$VALIDATION_RESULT" > /tmp/validation-results.md

      # Exit with appropriate code
      if [ "$BUILD_SUCCESS" = false ]; then
        exit 1
      fi
  after_script:
    # Post results to MR comment (only for merge requests)
    - |
      if [ "$CI_PIPELINE_SOURCE" = "merge_request_event" ] && [ -f /tmp/validation-results.md ]; then
        echo "Posting validation results to MR..."

        # Prepare the comment body
        COMMENT_BODY=$(cat /tmp/validation-results.md | jq -Rs .)

        # Post comment to MR using GitLab API
        curl -X POST \
          --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
          --header "Content-Type: application/json" \
          --data "{\"body\": $COMMENT_BODY}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes"

        echo "Results posted to MR #${CI_MERGE_REQUEST_IID}"
      fi
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - /tmp/validation-results.md

# Check against cluster policies
cluster-validate:
  extends: .flux-validation
  when: manual
  script:
    - |
      echo "=== Cluster Policy Validation ==="

      # Initialize results
      CLUSTER_RESULT="ðŸ” **Cluster Validation Results**\n\n"
      CLUSTER_SUCCESS=true

      # Build manifests and test with server-side validation
      echo "Building manifests..."
      if flux build kustomization manifests --path="./flux/manifests" --dry-run > /tmp/manifests.yaml 2>&1; then
        CLUSTER_RESULT+="âœ… **Manifest Build**: Success\n"
        echo "âœ… Manifests built successfully"

        echo "Testing against cluster policies..."
        if kubectl apply --dry-run=server --validate=true -f /tmp/manifests.yaml > /tmp/cluster-validation.log 2>&1; then
          CLUSTER_RESULT+="âœ… **Cluster Validation**: All manifests pass server-side validation\n"
          echo "âœ… Cluster validation passed"

          # Check for any policy violations or warnings
          if grep -i "warning\|blocked\|denied" /tmp/cluster-validation.log; then
            WARNINGS=$(grep -i "warning\|blocked\|denied" /tmp/cluster-validation.log)
            CLUSTER_RESULT+="\nâš ï¸ **Warnings/Notices**:\n\`\`\`\n${WARNINGS}\n\`\`\`\n"
          fi
        else
          CLUSTER_RESULT+="âŒ **Cluster Validation**: Failed server-side validation\n\`\`\`\n$(cat /tmp/cluster-validation.log)\n\`\`\`\n"
          CLUSTER_SUCCESS=false
          echo "âŒ Cluster validation failed"
        fi
      else
        CLUSTER_RESULT+="âŒ **Manifest Build**: Failed to build manifests\n\`\`\`\n$(cat /tmp/manifests.yaml)\n\`\`\`\n"
        CLUSTER_SUCCESS=false
        echo "âŒ Failed to build manifests"
      fi

      # Set overall result
      if [ "$CLUSTER_SUCCESS" = true ]; then
        CLUSTER_RESULT="âœ… **Cluster Validation Passed** ðŸŽ‰\n\n${CLUSTER_RESULT}"
        echo "âœ… Cluster validation completed successfully"
      else
        CLUSTER_RESULT="âŒ **Cluster Validation Failed** âš ï¸\n\n${CLUSTER_RESULT}"
        echo "âŒ Cluster validation failed"
      fi

      # Save results for posting to MR
      echo -e "$CLUSTER_RESULT" > /tmp/cluster-results.md

      # Exit with appropriate code
      if [ "$CLUSTER_SUCCESS" = false ]; then
        exit 1
      fi
  after_script:
    # Post results to MR comment (only for merge requests)
    - |
      if [ "$CI_PIPELINE_SOURCE" = "merge_request_event" ] && [ -f /tmp/cluster-results.md ]; then
        echo "Posting cluster validation results to MR..."

        # Prepare the comment body
        COMMENT_BODY=$(cat /tmp/cluster-results.md | jq -Rs .)

        # Post comment to MR using GitLab API
        curl -X POST \
          --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
          --header "Content-Type: application/json" \
          --data "{\"body\": $COMMENT_BODY}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes"

        echo "Cluster results posted to MR #${CI_MERGE_REQUEST_IID}"
      fi
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - /tmp/cluster-results.md
