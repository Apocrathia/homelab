---
kustomize-diff:
  stage: verify
  image: alpine:3.20
  variables:
    DIFF_REPORT_TITLE: "Homelab Kustomize Diff"
    DIFF_TARGET_DIR: "flux/manifests"
    DIFF_SCAN_PATH: "flux/manifests"
    DIFF_EXCLUDE: ""
    DIFF_ENV_FILE: "kustomize-diff.env"
  before_script:
    - apk add --no-cache git bash diffutils kustomize
    - git fetch origin $CI_DEFAULT_BRANCH
  script:
    - |
      echo "Computing changed kustomize roots under $DIFF_SCAN_PATH..."
      CHANGED_FILES=$(git diff --name-only origin/$CI_DEFAULT_BRANCH...HEAD -- "$DIFF_SCAN_PATH")
      if [ -n "$DIFF_EXCLUDE" ]; then
        CHANGED_FILES=$(echo "$CHANGED_FILES" | grep -v -E "$DIFF_EXCLUDE" || true)
      fi
      ROOTS=()
      find_root() {
        local p="$1"
        while [ "$p" != "/" -a "$p" != "." -a -n "$p" ]; do
          if [ -f "$p/kustomization.yaml" ]; then
            echo "$p"
            return 0
          fi
          p=$(dirname "$p")
        done
        return 1
      }
      if [ -z "$CHANGED_FILES" ]; then
        ROOTS+=("$DIFF_TARGET_DIR")
      else
        for f in $CHANGED_FILES; do
          dir=$(dirname "$f")
          r=$(find_root "$dir") || true
          if [ -n "$r" ]; then
            ROOTS+=("$r")
          fi
        done
      fi
      # dedupe
      CHANGED_DIRS=$(printf "%s\n" "${ROOTS[@]}" | sort -u | tr '\n' ' ')
      echo "CHANGED_DIRS=$CHANGED_DIRS" | tee $DIFF_ENV_FILE
      echo "Changed roots: $CHANGED_DIRS"
    - |
      set -e
      for d in $CHANGED_DIRS; do
        echo "=== Diff for $d ==="
        # Build base and head; allow remote bases by lifting restriction
        BASE_RENDER=$(mktemp)
        TARGET_RENDER=$(mktemp)
        KUSTOMIZE_BUILD_FLAGS="--enable-helm --load-restrictor LoadRestrictionsNone"
        kustomize build $KUSTOMIZE_BUILD_FLAGS "$d" > "$TARGET_RENDER"
        # Render base by checking out the base tree into a temp worktree
        BASE_DIR=$(mktemp -d)
        git worktree add --detach "$BASE_DIR" origin/$CI_DEFAULT_BRANCH
        cd "$BASE_DIR"
        kustomize build $KUSTOMIZE_BUILD_FLAGS "$d" > "$BASE_RENDER" || true
        cd - > /dev/null
        git worktree remove --force "$BASE_DIR"
        diff -u "$BASE_RENDER" "$TARGET_RENDER" || true
      done
  artifacts:
    reports:
      dotenv: $DIFF_ENV_FILE
