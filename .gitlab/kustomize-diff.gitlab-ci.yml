---
kustomize-diff:
  stage: verify
  image:
    name: alpine/k8s:1.34.1
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - flux/manifests/**/*
  script:
    - |
      MARKER="<!-- kustomize-diff -->"

      echo "=== Kustomize Diff Started ==="

      # Fetch target branch for comparison
      echo "Fetching target branch: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
      git fetch origin "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"

      # Find changed files in flux/manifests/
      echo "Finding changed manifest files..."
      CHANGED_FILES=$(git diff --name-only "origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"...HEAD -- flux/manifests/)
      echo "Changed files:"
      echo "$CHANGED_FILES"

      if [ -z "$CHANGED_FILES" ]; then
        echo "No manifest files changed"
        DIFF=""
      else
        # Find kustomization directories for changed files
        KUSTOMIZE_DIRS=""
        for FILE in $CHANGED_FILES; do
          DIR=$(dirname "$FILE")
          # Walk up to find nearest kustomization.yaml
          while [ "$DIR" != "." ] && [ "$DIR" != "flux/manifests" ]; do
            if [ -f "$DIR/kustomization.yaml" ]; then
              KUSTOMIZE_DIRS="$KUSTOMIZE_DIRS $DIR"
              break
            fi
            DIR=$(dirname "$DIR")
          done
        done

        # Deduplicate directories
        KUSTOMIZE_DIRS=$(echo "$KUSTOMIZE_DIRS" | tr ' ' '\n' | sort -u | grep -v '^$')
        echo "Kustomization directories to build:"
        echo "$KUSTOMIZE_DIRS"

        if [ -z "$KUSTOMIZE_DIRS" ]; then
          echo "No kustomization directories found for changed files"
          DIFF=""
        else
          # Build MR branch manifests
          echo "Building manifests for MR branch..."
          : > /tmp/mr.yaml
          for DIR in $KUSTOMIZE_DIRS; do
            echo "  Building $DIR"
            echo "---" >> /tmp/mr.yaml
            echo "# Source: $DIR" >> /tmp/mr.yaml
            kustomize build "$DIR" >> /tmp/mr.yaml 2>&1 || echo "# Build failed for $DIR" >> /tmp/mr.yaml
          done

          # Switch to target branch and build
          git checkout "origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"

          echo "Building manifests for target branch..."
          : > /tmp/target.yaml
          for DIR in $KUSTOMIZE_DIRS; do
            if [ -d "$DIR" ]; then
              echo "  Building $DIR"
              echo "---" >> /tmp/target.yaml
              echo "# Source: $DIR" >> /tmp/target.yaml
              kustomize build "$DIR" >> /tmp/target.yaml 2>&1 || echo "# Build failed for $DIR" >> /tmp/target.yaml
            else
              echo "  Directory $DIR doesn't exist on target branch (new component)"
            fi
          done

          # Switch back to MR branch
          git checkout "$CI_COMMIT_SHA"

          # Generate diff
          echo "Generating diff..."
          DIFF=$(diff -u /tmp/target.yaml /tmp/mr.yaml || true)
        fi
      fi

      # Create hash of diff content for comparison
      if [ -n "$DIFF" ]; then
        DIFF_HASH=$(echo "$DIFF" | md5sum | cut -d' ' -f1)
        COMMENT_BODY="${MARKER}
      ## üîç Kustomize Diff

      <details><summary>Click to expand diff</summary>

      \`\`\`diff
      ${DIFF}
      \`\`\`

      </details>

      <!-- hash:${DIFF_HASH} -->"
      else
        DIFF_HASH="no-changes"
        COMMENT_BODY="${MARKER}
      ## üîç Kustomize Diff

      No changes detected in rendered manifests.

      <!-- hash:${DIFF_HASH} -->"
      fi

      echo "Diff hash: $DIFF_HASH"

      # Fetch existing notes to find previous kustomize-diff comment
      echo "Checking for existing kustomize-diff comment..."
      echo "API URL: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes"

      NOTES=$(curl --silent --show-error --fail \
        --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes?per_page=100") || {
        echo "‚ùå Failed to fetch MR notes. CI_JOB_TOKEN may lack API permissions."
        echo "Check Settings ‚Üí CI/CD ‚Üí Token Access"
        exit 1
      }

      # Find existing comment with our marker
      EXISTING_NOTE=$(echo "$NOTES" | jq -r --arg marker "$MARKER" '.[] | select(.body | startswith($marker))')
      EXISTING_NOTE_ID=$(echo "$EXISTING_NOTE" | jq -r '.id // empty')
      EXISTING_HASH=$(echo "$EXISTING_NOTE" | jq -r '.body // ""' | sed -n 's/.*<!-- hash:\([^ ]*\) -->.*/\1/p')

      if [ -n "$EXISTING_NOTE_ID" ]; then
        echo "Found existing comment (ID: $EXISTING_NOTE_ID)"
        echo "Existing hash: $EXISTING_HASH"

        if [ "$EXISTING_HASH" = "$DIFF_HASH" ]; then
          echo "‚úÖ Diff unchanged, skipping update"
          exit 0
        fi

        echo "Diff changed, updating existing comment..."
        curl --silent --show-error --fail --request PUT \
          --header "PRIVATE-TOKEN: ${KUSTOMIZE_TOKEN}" \
          --header "Content-Type: application/json" \
          --data "$(jq -n --arg body "$COMMENT_BODY" '{body: $body}')" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes/${EXISTING_NOTE_ID}" > /dev/null

        echo "‚úÖ Comment updated successfully"
      else
        echo "No existing comment found, posting new one..."
        curl --silent --show-error --fail --request POST \
          --header "PRIVATE-TOKEN: ${KUSTOMIZE_TOKEN}" \
          --header "Content-Type: application/json" \
          --data "$(jq -n --arg body "$COMMENT_BODY" '{body: $body}')" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes" > /dev/null

        echo "‚úÖ Comment posted successfully"
      fi

      echo "=== Kustomize Diff Completed ==="
  allow_failure: true
