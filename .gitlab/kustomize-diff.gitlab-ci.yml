---
kustomize-diff:
  stage: verify
  image: cgr.dev/chainguard/git:latest
  variables:
    DIFF_REPORT_TITLE: "Homelab Kustomize Diff"
    DIFF_TARGET_DIR: "flux/manifests"
    DIFF_SCAN_PATH: "flux/manifests"
    DIFF_EXCLUDE: ""
    DIFF_ENV_FILE: "kustomize-diff.env"
    # renovate: datasource=github-releases depName=kubernetes-sigs/kustomize
    KUSTOMIZE_VERSION: "v5.4.2"
  before_script:
    - |
      set -e
      # simple fetch helper supporting curl or wget
      fetch() { if command -v curl >/dev/null 2>&1; then curl -fsSL "$1" -o "$2"; else wget -q "$1" -O "$2"; fi }
      # install kustomize locally
      mkdir -p .ci/bin && export PATH="$PWD/.ci/bin:$PATH"
      if ! command -v kustomize >/dev/null 2>&1; then
        OS="linux"
        ARCH="$(uname -m)"; [ "$ARCH" = "x86_64" ] && ARCH=amd64; [ "$ARCH" = "aarch64" ] && ARCH=arm64
        KVER="${KUSTOMIZE_VERSION}"
        TARBALL="kustomize_${KVER}_${OS}_${ARCH}.tar.gz"
        URL="https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2F${KVER}/${TARBALL}"
        fetch "$URL" kustomize.tgz
        tar -xzf kustomize.tgz -C .ci/bin kustomize && chmod +x .ci/bin/kustomize && rm -f kustomize.tgz
      fi
      git fetch origin $CI_DEFAULT_BRANCH
  script:
    - |
      echo "Computing changed kustomize roots under $DIFF_SCAN_PATH..."
      CHANGED_FILES=$(git diff --name-only origin/$CI_DEFAULT_BRANCH...HEAD -- "$DIFF_SCAN_PATH")
      if [ -n "$DIFF_EXCLUDE" ]; then
        CHANGED_FILES=$(echo "$CHANGED_FILES" | grep -v -E "$DIFF_EXCLUDE" || true)
      fi
      find_root() {
        local p="$1"
        while [ "$p" != "/" -a "$p" != "." -a -n "$p" ]; do
          if [ -f "$p/kustomization.yaml" ]; then
            echo "$p"
            return 0
          fi
          p=$(dirname "$p")
        done
        return 1
      }
      if [ -z "$CHANGED_FILES" ]; then
        CHANGED_DIRS="$DIFF_TARGET_DIR"
      else
        CHANGED_DIRS=$(echo "$CHANGED_FILES" | while read -r f; do dir=$(dirname "$f"); find_root "$dir"; done | sort -u | tr '\n' ' ')
      fi
      # fallback
      [ -n "$CHANGED_DIRS" ] || CHANGED_DIRS="$DIFF_TARGET_DIR"
      echo "CHANGED_DIRS=$CHANGED_DIRS" | tee $DIFF_ENV_FILE
      echo "Changed roots: $CHANGED_DIRS"
    - |
      set -e
      for d in $CHANGED_DIRS; do
        echo "=== Diff for $d ==="
        # Build base and head; allow remote bases by lifting restriction
        BASE_RENDER=$(mktemp)
        TARGET_RENDER=$(mktemp)
        KUSTOMIZE_BUILD_FLAGS="--enable-helm --load-restrictor LoadRestrictionsNone"
        kustomize build $KUSTOMIZE_BUILD_FLAGS "$d" > "$TARGET_RENDER"
        # Render base by checking out the base tree into a temp worktree
        BASE_DIR=$(mktemp -d)
        git worktree add --detach "$BASE_DIR" origin/$CI_DEFAULT_BRANCH
        (cd "$BASE_DIR" && kustomize build $KUSTOMIZE_BUILD_FLAGS "$d" > "$BASE_RENDER" || true)
        git worktree remove --force "$BASE_DIR"
        diff -u "$BASE_RENDER" "$TARGET_RENDER" || true
      done
  artifacts:
    reports:
      dotenv: $DIFF_ENV_FILE
