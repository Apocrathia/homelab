---
kustomize-diff:
  stage: verify
  image:
    name: alpine/k8s:1.34.1
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - flux/manifests/**/*
  script:
    - |
      MARKER="<!-- kustomize-diff -->"
      DIFF_COLLAPSE_THRESHOLD=50

      # Sanitize branch names for use as filenames
      TARGET_FILE="/tmp/$(echo "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" | tr '/' '-').yaml"
      SOURCE_FILE="/tmp/$(echo "$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME" | tr '/' '-').yaml"

      echo "=== Kustomize Diff Started ==="

      # Fetch target branch for comparison
      echo "Fetching target branch: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
      git fetch origin "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"

      # Find changed files in flux/manifests/
      echo "Finding changed manifest files..."
      CHANGED_FILES=$(git diff --name-only "origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"...HEAD -- flux/manifests/)
      echo "Changed files:"
      echo "$CHANGED_FILES"

      if [ -z "$CHANGED_FILES" ]; then
        echo "No manifest files changed"
        DIFF=""
      else
        # Find kustomization directories for changed files
        KUSTOMIZE_DIRS=""
        for FILE in $CHANGED_FILES; do
          DIR=$(dirname "$FILE")
          # Walk up to find nearest kustomization.yaml
          while [ "$DIR" != "." ] && [ "$DIR" != "flux/manifests" ]; do
            if [ -f "$DIR/kustomization.yaml" ]; then
              KUSTOMIZE_DIRS="$KUSTOMIZE_DIRS $DIR"
              break
            fi
            DIR=$(dirname "$DIR")
          done
        done

        # Deduplicate directories
        KUSTOMIZE_DIRS=$(echo "$KUSTOMIZE_DIRS" | tr ' ' '\n' | sort -u | grep -v '^$')
        echo "Kustomization directories to build:"
        echo "$KUSTOMIZE_DIRS"

        if [ -z "$KUSTOMIZE_DIRS" ]; then
          echo "No kustomization directories found for changed files"
          DIFF=""
        else
          # Build MR branch manifests
          echo "Building manifests for MR branch ($CI_MERGE_REQUEST_SOURCE_BRANCH_NAME)..."
          : > "$SOURCE_FILE"
          for DIR in $KUSTOMIZE_DIRS; do
            echo "  Building $DIR"
            echo "---" >> "$SOURCE_FILE"
            echo "# Source: $DIR" >> "$SOURCE_FILE"
            kustomize build "$DIR" >> "$SOURCE_FILE" 2>&1 || echo "# Build failed for $DIR" >> "$SOURCE_FILE"
          done

          # Switch to target branch and build
          git checkout "origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"

          echo "Building manifests for target branch ($CI_MERGE_REQUEST_TARGET_BRANCH_NAME)..."
          : > "$TARGET_FILE"
          for DIR in $KUSTOMIZE_DIRS; do
            if [ -d "$DIR" ]; then
              echo "  Building $DIR"
              echo "---" >> "$TARGET_FILE"
              echo "# Source: $DIR" >> "$TARGET_FILE"
              kustomize build "$DIR" >> "$TARGET_FILE" 2>&1 || echo "# Build failed for $DIR" >> "$TARGET_FILE"
            else
              echo "  Directory $DIR doesn't exist on target branch (new component)"
            fi
          done

          # Switch back to MR branch
          git checkout "$CI_COMMIT_SHA"

          # Generate diff
          echo "Generating diff..."
          DIFF=$(diff -u "$TARGET_FILE" "$SOURCE_FILE" || true)
        fi
      fi

      # Create hash of diff content for comparison
      COMMENT_FILE="/tmp/comment.md"
      if [ -n "$DIFF" ]; then
        DIFF_HASH=$(echo "$DIFF" | md5sum | cut -d' ' -f1)
        DIFF_LINES=$(echo "$DIFF" | wc -l)
        echo "Diff is $DIFF_LINES lines"

        {
          echo "$MARKER"
          echo "## üîç Kustomize Diff"
          echo ""
          if [ "$DIFF_LINES" -gt "$DIFF_COLLAPSE_THRESHOLD" ]; then
            echo "<details><summary>Click to expand diff (${DIFF_LINES} lines)</summary>"
            echo ""
          fi
          echo '```diff'
          echo "$DIFF"
          echo '```'
          if [ "$DIFF_LINES" -gt "$DIFF_COLLAPSE_THRESHOLD" ]; then
            echo ""
            echo "</details>"
          fi
          echo ""
          echo "<!-- hash:${DIFF_HASH} -->"
        } > "$COMMENT_FILE"
      else
        DIFF_HASH="no-changes"
        {
          echo "$MARKER"
          echo "## üîç Kustomize Diff"
          echo ""
          echo "No changes detected in rendered manifests."
          echo ""
          echo "<!-- hash:${DIFF_HASH} -->"
        } > "$COMMENT_FILE"
      fi
      COMMENT_BODY=$(cat "$COMMENT_FILE")

      echo "Diff hash: $DIFF_HASH"

      # Fetch existing notes to find previous kustomize-diff comment
      echo "Checking for existing kustomize-diff comment..."
      echo "API URL: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes"

      NOTES=$(curl --silent --show-error --fail \
        --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes?per_page=100") || {
        echo "‚ùå Failed to fetch MR notes. CI_JOB_TOKEN may lack API permissions."
        echo "Check Settings ‚Üí CI/CD ‚Üí Token Access"
        exit 1
      }

      # Find existing comment with our marker
      EXISTING_NOTE=$(echo "$NOTES" | jq -r --arg marker "$MARKER" '.[] | select(.body | startswith($marker))')
      EXISTING_NOTE_ID=$(echo "$EXISTING_NOTE" | jq -r '.id // empty')
      EXISTING_HASH=$(echo "$EXISTING_NOTE" | jq -r '.body // ""' | sed -n 's/.*<!-- hash:\([^ ]*\) -->.*/\1/p')

      if [ -n "$EXISTING_NOTE_ID" ]; then
        echo "Found existing comment (ID: $EXISTING_NOTE_ID)"
        echo "Existing hash: $EXISTING_HASH"

        if [ "$EXISTING_HASH" = "$DIFF_HASH" ]; then
          echo "‚úÖ Diff unchanged, skipping update"
          exit 0
        fi

        echo "Diff changed, updating existing comment..."
        curl --silent --show-error --fail --request PUT \
          --header "PRIVATE-TOKEN: ${KUSTOMIZE_TOKEN}" \
          --header "Content-Type: application/json" \
          --data "$(jq -n --arg body "$COMMENT_BODY" '{body: $body}')" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes/${EXISTING_NOTE_ID}" > /dev/null

        echo "‚úÖ Comment updated successfully"
      else
        echo "No existing comment found, posting new one..."
        curl --silent --show-error --fail --request POST \
          --header "PRIVATE-TOKEN: ${KUSTOMIZE_TOKEN}" \
          --header "Content-Type: application/json" \
          --data "$(jq -n --arg body "$COMMENT_BODY" '{body: $body}')" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes" > /dev/null

        echo "‚úÖ Comment posted successfully"
      fi

      echo "=== Kustomize Diff Completed ==="
  allow_failure: true
