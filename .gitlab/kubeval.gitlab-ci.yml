---
kubeval:
  stage: verify
  image: ghcr.io/yannh/kubeconform:v0.7.0-alpine
  needs:
    - job: kustomize-diff
      artifacts: true
  variables:
    CHANGED_DIRS: "$CHANGED_DIRS"
    KUBECONFORM_FLAGS: "-strict -ignore-missing-schemas -summary"
    KUBECONFORM_SCHEMA_LOCATION: ""
  before_script:
    - apk add --no-cache curl bash git kustomize
  script:
    - |
      set -e
      if [ -z "$CHANGED_DIRS" ]; then
        CHANGED_DIRS="$KUSTOMIZE_DIR"
      fi
      echo "Validating: $CHANGED_DIRS"
      for d in $CHANGED_DIRS; do
        echo "=== kubeconform $d ==="
        if [ -n "$KUBECONFORM_SCHEMA_LOCATION" ]; then
          kustomize build --load-restrictor LoadRestrictionsNone "$d" | kubeconform $KUBECONFORM_FLAGS -schema-location "$KUBECONFORM_SCHEMA_LOCATION" || exit 1
        else
          kustomize build --load-restrictor LoadRestrictionsNone "$d" | kubeconform $KUBECONFORM_FLAGS || exit 1
        fi
      done
