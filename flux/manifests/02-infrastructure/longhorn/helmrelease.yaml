---
# yaml-language-server: $schema=https://kubernetes-schemas.devbu.io/helm.toolkit.fluxcd.io/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: longhorn
  namespace: longhorn-system
spec:
  interval: 30m
  chart:
    spec:
      chart: longhorn
      # renovate: datasource=helm registryUrl=https://charts.longhorn.io depName=longhorn
      version: 1.8.0
      sourceRef:
        kind: HelmRepository
        name: longhorn
        namespace: flux-system
  maxHistory: 2
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    # Default values for longhorn.
    # This is a YAML-formatted file.
    # Declare variables to be passed into your templates.
    global:
      cattle:
        systemDefaultRegistry: ""
        windowsCluster:
          # Enable this to allow Longhorn to run on the Rancher deployed Windows cluster
          enabled: false
          # Tolerate Linux node taint
          tolerations:
            - key: "cattle.io/os"
              value: "linux"
              effect: "NoSchedule"
              operator: "Equal"
          # Select Linux nodes
          nodeSelector:
            kubernetes.io/os: "linux"
          # Recognize toleration and node selector for Longhorn run-time created components
          defaultSetting:
            taintToleration: cattle.io/os=linux:NoSchedule
            systemManagedComponentsNodeSelector: kubernetes.io/os:linux

    networkPolicies:
      enabled: false
      # Available types: k3s, rke2, rke1
      type: "k3s"

    service:
      ui:
        type: ClusterIP
        nodePort: null
      manager:
        type: ClusterIP
        nodePort: ""
        loadBalancerIP: ""
        loadBalancerSourceRanges: ""

    persistence:
      defaultClass: true
      defaultFsType: ext4
      defaultMkfsParams: ""
      defaultClassReplicaCount: 3
      defaultDataLocality: disabled
      reclaimPolicy: Delete
      migratable: false
      recurringJobSelector:
        enable: false
        jobList: []
      backingImage:
        enable: false
        name: ~
        dataSourceType: ~
        dataSourceParameters: ~
        expectedChecksum: ~
      defaultNodeSelector:
        enable: false
        selector: ""
      removeSnapshotsDuringFilesystemTrim: ignored

    helmPreUpgradeCheckerJob:
      enabled: true

    csi:
      kubeletRootDir: ~
      attacherReplicaCount: ~
      provisionerReplicaCount: ~
      resizerReplicaCount: ~
      snapshotterReplicaCount: ~

    defaultSettings:
      backupTarget: cifs://diskstation.apocrathia.com/Kubernetes
      backupTargetCredentialSecret: longhorn-backup-target-secret
      allowRecurringJobWhileVolumeDetached: ~
      createDefaultDiskLabeledNodes: ~
      defaultDataPath: ~
      defaultDataLocality: ~
      replicaSoftAntiAffinity: ~
      replicaAutoBalance: ~
      storageOverProvisioningPercentage: ~
      storageMinimalAvailablePercentage: ~
      storageReservedPercentageForDefaultDisk: ~
      upgradeChecker: ~
      defaultReplicaCount: ~
      defaultLonghornStaticStorageClass: ~
      backupstorePollInterval: ~
      failedBackupTTL: ~
      restoreVolumeRecurringJobs: true
      recurringSuccessfulJobsHistoryLimit: ~
      recurringFailedJobsHistoryLimit: ~
      supportBundleFailedHistoryLimit: ~
      taintToleration: ~
      systemManagedComponentsNodeSelector: ~
      priorityClass: ~
      autoSalvage: ~
      autoDeletePodWhenVolumeDetachedUnexpectedly: ~
      disableSchedulingOnCordonedNode: ~
      replicaZoneSoftAntiAffinity: ~
      nodeDownPodDeletionPolicy: ~
      nodeDrainPolicy: ~
      replicaReplenishmentWaitInterval: ~
      concurrentReplicaRebuildPerNodeLimit: ~
      concurrentVolumeBackupRestorePerNodeLimit: ~
      disableRevisionCounter: ~
      systemManagedPodsImagePullPolicy: ~
      allowVolumeCreationWithDegradedAvailability: ~
      autoCleanupSystemGeneratedSnapshot: ~
      concurrentAutomaticEngineUpgradePerNodeLimit: ~
      backingImageCleanupWaitInterval: ~
      backingImageRecoveryWaitInterval: ~
      guaranteedInstanceManagerCPU: ~
      kubernetesClusterAutoscalerEnabled: ~
      orphanAutoDeletion: ~
      storageNetwork: ~
      deletingConfirmationFlag: ~
      engineReplicaTimeout: ~
      snapshotDataIntegrity: ~
      snapshotDataIntegrityImmediateCheckAfterSnapshotCreation: ~
      snapshotDataIntegrityCronjob: ~
      removeSnapshotsDuringFilesystemTrim: ~
      fastReplicaRebuildEnabled: ~
      replicaFileSyncHttpClientTimeout: ~
      logLevel: ~
      backupCompressionMethod: gzip
      backupConcurrentLimit: ~
      restoreConcurrentLimit: ~
      v2DataEngine: ~
      offlineReplicaRebuilding: ~
    privateRegistry:
      createSecret: ~
      registryUrl: ~
      registryUser: ~
      registryPasswd: ~
      registrySecret: ~

    longhornManager:
      log:
        ## Allowed values are `plain` or `json`.
        format: plain
      priorityClass: ~
      tolerations: []
      ## If you want to set tolerations for Longhorn Manager DaemonSet, delete the `[]` in the line above
      ## and uncomment this example block
      # - key: "key"
      #   operator: "Equal"
      #   value: "value"
      #   effect: "NoSchedule"
      nodeSelector: {}
      ## If you want to set node selector for Longhorn Manager DaemonSet, delete the `{}` in the line above
      ## and uncomment this example block
      #  label-key1: "label-value1"
      #  label-key2: "label-value2"
      serviceAnnotations: {}
      ## If you want to set annotations for the Longhorn Manager service, delete the `{}` in the line above
      ## and uncomment this example block
      #  annotation-key1: "annotation-value1"
      #  annotation-key2: "annotation-value2"

    longhornDriver:
      priorityClass: ~
      tolerations: []
      ## If you want to set tolerations for Longhorn Driver Deployer Deployment, delete the `[]` in the line above
      ## and uncomment this example block
      # - key: "key"
      #   operator: "Equal"
      #   value: "value"
      #   effect: "NoSchedule"
      nodeSelector: {}
      ## If you want to set node selector for Longhorn Driver Deployer Deployment, delete the `{}` in the line above
      ## and uncomment this example block
      #  label-key1: "label-value1"
      #  label-key2: "label-value2"

    longhornUI:
      replicas: 2
      priorityClass: ~
      tolerations: []
      ## If you want to set tolerations for Longhorn UI Deployment, delete the `[]` in the line above
      ## and uncomment this example block
      # - key: "key"
      #   operator: "Equal"
      #   value: "value"
      #   effect: "NoSchedule"
      nodeSelector: {}
      ## If you want to set node selector for Longhorn UI Deployment, delete the `{}` in the line above
      ## and uncomment this example block
      #  label-key1: "label-value1"
      #  label-key2: "label-value2"

    ingress:
      ## Set to true to enable ingress record generation
      enabled: false

      ## Add ingressClassName to the Ingress
      ## Can replace the kubernetes.io/ingress.class annotation on v1.18+
      ingressClassName: ~

      host: longhorn.k8s.apocrathia.com

      ## Set this to true in order to enable TLS on the ingress record
      tls: false

      ## Enable this in order to enable that the backend service will be connected at port 443
      secureBackends: false

      ## If TLS is set to true, you must declare what secret will store the key/certificate for TLS
      tlsSecret: longhorn.local-tls

      ## If ingress is enabled you can set the default ingress path
      ## then you can access the UI by using the following full path {{host}}+{{path}}
      path: /

      ## Ingress annotations done as key:value pairs
      ## If you're using kube-lego, you will want to add:
      ## kubernetes.io/tls-acme: true
      ##
      ## For a full list of possible ingress annotations, please see
      ## ref: https://github.com/kubernetes/ingress-nginx/blob/master/docs/annotations.md
      ##
      ## If tls is set to true, annotation ingress.kubernetes.io/secure-backends: "true" will automatically be set
      annotations:
      #  kubernetes.io/ingress.class: nginx
      #  kubernetes.io/tls-acme: true

      secrets:
      ## If you're providing your own certificates, please use this to add the certificates as secrets
      ##
      ## name should line up with a tlsSecret set further up
      ## If you're using kube-lego, this is unneeded, as it will create the secret for you if it is not set
      ##
      ## It is also possible to create and manage the certificates outside of this helm chart
      ## Please see README.md for more information
      # - name: longhorn.local-tls
      #   key:
      #   certificate:

    #  For Kubernetes < v1.25, if your cluster enables Pod Security Policy admission controller,
    #  set this to `true` to ship longhorn-psp which allow privileged Longhorn pods to start
    enablePSP: false

    ## Specify override namespace, specifically this is useful for using longhorn as sub-chart
    ## and its release namespace is not the `longhorn-system`
    namespaceOverride: ""

    # Annotations to add to the Longhorn Manager DaemonSet Pods. Optional.
    annotations: {}

    serviceAccount:
      # Annotations to add to the service account
      annotations: {}
