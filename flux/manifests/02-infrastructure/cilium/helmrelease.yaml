---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cilium
  namespace: cilium-system
spec:
  interval: 30m
  chart:
    spec:
      chart: cilium
      # renovate: datasource=helm registryUrl=https://helm.cilium.io depName=cilium
      version: "1.18.5"
      sourceRef:
        kind: HelmRepository
        name: cilium
        namespace: flux-system
      interval: 30m
  install:
    crds: Create
  values:
    namespaceOverride: cilium-system

    annotateK8sNode: true

    operator:
      unmanagedPodWatcher:
        restart: false # Don't restart unmigrated pods during migration
      enabled: true
      replicas: 1
      # Allow Cilium Operator to run on any node
      affinity: {}
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          memory: 256Mi
      # Enable prometheus metrics
      prometheus:
        enabled: true
        serviceMonitor:
          enabled: true

    # CNI configuration for migration and Talos compatibility
    cni:
      install: true
      exclusive: true
      chainingMode: none
      customConf: false # Changed from true to false for Talos
      uninstall: false # Don't remove CNI config on shutdown
      confPath: /etc/cni/net.d
      binPath: /opt/cni/bin

    # BPF configuration
    bpf:
      masquerade: true
      hostRouting: true # Enable BPF host routing for BBR to work
      hostLegacyRouting: false # Disable legacy routing as we're using BPF host routing

    # Disable policy enforcement during migration
    policyEnforcementMode: "never"

    # Enable Hubble with modern secure defaults
    hubble:
      enabled: true
      ui:
        enabled: true
        securityContext:
          enabled: true
        # Allow Hubble UI to run on any node
        affinity: {}
        backend:
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
        frontend:
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
      tls:
        enabled: false
      # Enhanced Hubble metrics configuration
      metrics:
        enabled:
          - dns:query;ignoreAAAA
          - drop
          - tcp
          - flow
          - port-distribution
          - icmp
          - httpV2:exemplars=true;labelsContext=source_ip,source_namespace,source_workload,destination_ip,destination_namespace,destination_workload,traffic_direction
        enableOpenMetrics: true
        serviceMonitor:
          enabled: true
      relay:
        enabled: true
        # Allow Hubble Relay to run on any node
        affinity: {}
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 100m
            memory: 128Mi
        prometheus:
          enabled: true
          serviceMonitor:
            enabled: true

    # Enable built-in DNS proxy with NextDNS
    dnsProxy:
      enabled: true
      # NextDNS upstream servers
      upstream:
        - 45.90.28.214
        - 45.90.30.214

    # Enable IPv4 and disable IPv6 for homelab setup
    ipv4:
      enabled: true
    ipv6:
      enabled: false

    # Configure IPv4 native routing CIDR (required for native routing mode)
    ipv4NativeRoutingCIDR: "10.42.0.0/16"

    # Cluster mesh disabled for single cluster
    clustermesh:
      useAPIServer: false

    # Configure monitoring with ServiceMonitor
    prometheus:
      enabled: true
      serviceMonitor:
        enabled: true

    # Configure routing mode
    routingMode: native
    autoDirectNodeRoutes: true

    # Resource configuration for cilium-agent
    resources:
      requests:
        cpu: 500m
        memory: 512Mi
      limits:
        cpu: 2000m
        memory: 2Gi

    # Security context for agent pods - modified for Talos compatibility
    securityContext:
      privileged: false
      capabilities:
        ciliumAgent:
          - CHOWN
          - KILL
          - NET_ADMIN
          - NET_RAW
          - IPC_LOCK
          - SYS_ADMIN
          - SYS_RESOURCE
          - DAC_OVERRIDE
          - FOWNER
          - SETGID
          - SETUID
          - NET_BIND_SERVICE # Added for embedded Envoy to bind to privileged ports
        cleanCiliumState:
          - NET_ADMIN
          - SYS_ADMIN
          - SYS_RESOURCE

    # Configure kubeproxy replacement
    kubeProxyReplacement: true
    k8sServiceHost: "127.0.0.1"
    k8sServicePort: 6443 # Use localhost to avoid VIP routing issues on control plane nodes

    # Enable bandwidth manager for better traffic control
    bandwidthManager:
      enabled: true
      bbr: true

    # Enable native routing CIDR for better performance
    ipam:
      mode: kubernetes
      operator:
        clusterPoolIPv4PodCIDR: "10.42.0.0/16"

    # Enable load balancing mode
    loadBalancer:
      algorithm: maglev
      mode: hybrid

    # Enable BGP support if needed
    bgp:
      enabled: false

    # Enable Envoy support
    envoy:
      enabled: true
      # Allow Envoy proxy to run on any node
      affinity: {}
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 200m
          memory: 512Mi
      rollOutPods: true
      # Enable Envoy metrics
      prometheus:
        enabled: true
        serviceMonitor:
          enabled: true

    # Disable host firewall for Talos compatibility
    hostFirewall:
      enabled: false

    # Disable IP masquerade agent as we're using BPF masquerade
    enableIPMasqAgent: false

    # Add cgroup configuration for Talos
    cgroup:
      autoMount:
        enabled: false
      hostRoot: /sys/fs/cgroup

    # Talos-specific configuration to avoid CoreDNS issues
    # See: https://www.talos.dev/v1.9/kubernetes-guides/network/deploying-cilium/#known-issues
    enableXTSocketFallback: false
    installNoConntrackIptablesRules: false

    # Disable forwarding DNS to host to avoid CoreDNS issues
    # See: https://www.talos.dev/v1.9/kubernetes-guides/network/deploying-cilium/#known-issues
    k8s:
      requireIPv4PodCIDR: true

    # Enable socket LB for better performance
    socketLB:
      enabled: true

    # Enable nodePort for external access
    nodePort:
      enabled: true

    # Enable host services for better integration
    hostServices:
      enabled: true

    # Enable external IPs support
    externalIPs:
      enabled: true

    # Enable hostPort support
    hostPort:
      enabled: true

    # Disable forwarding DNS to host to avoid CoreDNS issues with Talos
    # See: https://www.talos.dev/v1.9/kubernetes-guides/network/deploying-cilium/#known-issues
    forwardKubeDNSToHost: false

    # Enable sidecar monitor for better observability
    monitor:
      enabled: true

    # Enable L2 announcements for LoadBalancer services
    l2announcements:
      enabled: true
      leaseDuration: 15s
      leaseRenewDeadline: 5s
      leaseRetryPeriod: 2s
    l2podannouncements:
      enabled: true

    # Configure k8s client rate limits for L2 announcements
    k8sClientRateLimit:
      qps: 10
      burst: 20

    # Gateway API configuration
    gatewayAPI:
      enabled: true
      hostNetwork:
        enabled: false
      secretsNamespace:
        create: true
        name: cilium-secrets
        sync: true

    # Egress Gateway configuration
    egressGateway:
      enabled: true
