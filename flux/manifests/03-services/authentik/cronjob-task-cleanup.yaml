---
# This CronJob addresses the following issue:
# https://github.com/goauthentik/authentik/issues/18915
apiVersion: batch/v1
kind: CronJob
metadata:
  name: authentik-task-cleanup
  namespace: authentik
spec:
  schedule: "0 * * * *" # Hourly
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            fsGroup: 1000
            seccompProfile:
              type: RuntimeDefault
          containers:
            - name: task-cleanup
              # renovate: datasource=docker registryUrl=https://ghcr.io depName=goauthentik/server
              image: ghcr.io/goauthentik/server:2025.10.3
              securityContext:
                readOnlyRootFilesystem: true
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
              command:
                - /bin/sh
                - -c
                - |
                  ak shell -c "
                  from authentik.tasks.models import Task
                  from django.db.models import Count
                  from django.utils import timezone
                  from datetime import timedelta

                  # Only clear tasks queued for more than 5 minutes (stale)
                  stale_threshold = timezone.now() - timedelta(minutes=5)

                  # Count before
                  queued = Task.objects.filter(state='queued').count()
                  print(f'Total queued tasks: {queued}')

                  if queued > 100:
                      # Clear stale outpost tasks that accumulate
                      stale_outpost = Task.objects.filter(
                          state='queued',
                          mtime__lt=stale_threshold,
                          actor_name__in=[
                              'authentik.outposts.tasks.outpost_send_update',
                              'authentik.outposts.tasks.outpost_controller',
                          ]
                      )
                      count = stale_outpost.count()
                      if count > 0:
                          deleted, _ = stale_outpost.delete()
                          print(f'Deleted {deleted} stale outpost tasks')

                      # If still heavily backed up, clear all stale queued tasks
                      remaining = Task.objects.filter(state='queued').count()
                      if remaining > 500:
                          stale_all = Task.objects.filter(
                              state='queued',
                              mtime__lt=stale_threshold
                          )
                          deleted, _ = stale_all.delete()
                          print(f'Deleted {deleted} additional stale tasks')

                      final = Task.objects.filter(state='queued').count()
                      print(f'Remaining queued tasks: {final}')
                  else:
                      print('Queue healthy, no cleanup needed')
                  "
              env:
                - name: AUTHENTIK_POSTGRESQL__HOST
                  value: authentik-postgres-rw.authentik.svc.cluster.local
                - name: AUTHENTIK_POSTGRESQL__PORT
                  value: "5432"
                - name: AUTHENTIK_POSTGRESQL__NAME
                  value: authentik
                - name: AUTHENTIK_POSTGRESQL__USER
                  valueFrom:
                    secretKeyRef:
                      name: authentik-secrets
                      key: username
                - name: AUTHENTIK_POSTGRESQL__PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: authentik-secrets
                      key: password
                - name: AUTHENTIK_SECRET_KEY
                  valueFrom:
                    secretKeyRef:
                      name: authentik-secrets
                      key: authentik-secret-key
              resources:
                requests:
                  cpu: 100m
                  memory: 512Mi
                limits:
                  cpu: 500m
                  memory: 1Gi
