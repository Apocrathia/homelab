---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authentik
  namespace: authentik
spec:
  interval: 5m
  chart:
    spec:
      chart: authentik
      # renovate: datasource=helm registryUrl=https://charts.goauthentik.io depName=authentik
      version: "2025.10.3"
      sourceRef:
        kind: HelmRepository
        name: authentik
        namespace: flux-system
      interval: 5m
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
    timeout: 15m
    # Remove for upgrade to 2025.12.0
    disableWait: true
  # Add memory limits to outposts to prevent OOM kills
  postRenderers:
    - kustomize:
        patches:
          - target:
              kind: Deployment
              labelSelector: app.kubernetes.io/name=authentik-proxy
            patch: |
              - op: add
                path: /spec/template/spec/containers/0/resources
                value:
                  requests:
                    cpu: 50m
                    memory: 32Mi
                  limits:
                    cpu: 200m
                    memory: 128Mi
  # Pull credentials from secret
  valuesFrom:
    - kind: Secret
      name: authentik-secrets
      valuesKey: username
      targetPath: authentik.postgresql.user
    - kind: Secret
      name: authentik-secrets
      valuesKey: password
      targetPath: authentik.postgresql.password
    - kind: Secret
      name: authentik-secrets
      valuesKey: bootstrap-password
      targetPath: authentik.bootstrap_password
    - kind: Secret
      name: authentik-secrets
      valuesKey: bootstrap-email
      targetPath: authentik.bootstrap_email
    - kind: Secret
      name: authentik-secrets
      valuesKey: authentik-secret-key
      targetPath: authentik.secret_key
  values:
    authentik:
      postgresql:
        host: authentik-postgres-rw.authentik.svc.cluster.local
        port: 5432
        name: authentik
        disable_server_side_cursors: true
        conn_max_age: 300
    postgresql:
      enabled: false
    redis:
      enabled: false

    server:
      replicas: 2
      resources:
        requests:
          cpu: 250m
          memory: 1Gi
        limits:
          cpu: 1000m
          memory: 4Gi
      volumes:
        - name: authentik-secrets
          secret:
            secretName: authentik-secrets
        - name: blueprints-sidecar
          emptyDir: {}
      volumeMounts:
        - name: authentik-secrets
          mountPath: /authentik-secrets
          readOnly: true
        - name: blueprints-sidecar
          mountPath: /blueprints/user
          readOnly: true
      extraContainers:
        - name: sidecar-blueprints
          # renovate: datasource=docker registryUrl=https://ghcr.io depName=home-operations/k8s-sidecar
          image: "ghcr.io/home-operations/k8s-sidecar:2.2.2"
          env:
            - name: "LABEL"
              value: "authentik_blueprint"
            - name: "LABEL_VALUE"
              value: "true"
            - name: "NAMESPACE"
              value: "ALL"
            - name: "FOLDER"
              value: "/blueprints/user"
            - name: "IGNORE_ALREADY_PROCESSED"
              value: "true"
          volumeMounts:
            - name: blueprints-sidecar
              mountPath: /blueprints/user
          resources:
            requests:
              cpu: 10m
              memory: 128Mi
            limits:
              memory: 256Mi

    worker:
      replicas: 2
      env:
        - name: AUTHENTIK_WORKER__THREADS
          value: "2"
        - name: AUTHENTIK_WORKER__SCHEDULER_INTERVAL
          value: "hours=1"
        - name: AUTHENTIK_CACHE__TIMEOUT
          value: "60"
        - name: AUTHENTIK_CACHE__TIMEOUT_FLOWS
          value: "60"
        - name: AUTHENTIK_CACHE__TIMEOUT_POLICIES
          value: "60"
      resources:
        requests:
          cpu: 500m
          memory: 512Mi
        limits:
          cpu: 2000m
          memory: 2Gi
      livenessProbe:
        timeoutSeconds: 30
        failureThreshold: 5
      readinessProbe:
        timeoutSeconds: 30
      startupProbe:
        timeoutSeconds: 30
        initialDelaySeconds: 60
      volumes:
        - name: authentik-secrets
          secret:
            secretName: authentik-secrets
        - name: blueprints-sidecar
          emptyDir: {}
      volumeMounts:
        - name: authentik-secrets
          mountPath: /authentik-secrets
          readOnly: true
        - name: blueprints-sidecar
          mountPath: /blueprints/user
          readOnly: true
      extraContainers:
        - name: sidecar-blueprints
          # renovate: datasource=docker registryUrl=https://ghcr.io depName=home-operations/k8s-sidecar
          image: "ghcr.io/home-operations/k8s-sidecar:2.2.2"
          env:
            - name: "LABEL"
              value: "authentik_blueprint"
            - name: "LABEL_VALUE"
              value: "true"
            - name: "NAMESPACE"
              value: "ALL"
            - name: "FOLDER"
              value: "/blueprints/user"
            - name: "IGNORE_ALREADY_PROCESSED"
              value: "true"
          volumeMounts:
            - name: blueprints-sidecar
              mountPath: /blueprints/user
          resources:
            requests:
              cpu: 10m
              memory: 128Mi
            limits:
              memory: 256Mi
