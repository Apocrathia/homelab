---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authentik
  namespace: authentik
spec:
  interval: 5m
  chart:
    spec:
      chart: authentik
      # renovate: datasource=helm registryUrl=https://charts.goauthentik.io depName=authentik
      version: "2025.8.1"
      sourceRef:
        kind: HelmRepository
        name: authentik
        namespace: flux-system
      interval: 5m
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    global:
      podAnnotations:
        reloader.stakater.com/auto: "true"
    authentik:
      secret_key: file:///authentik-secrets/authentik-secret-key
      postgresql.password: file:///authentik-secrets/postgres-password
    postgresql:
      enabled: true
      auth:
        username: authentik
        existingSecret: authentik-secrets
        secretKeys:
          adminPasswordKey: postgres-password
          userPasswordKey: postgres-password
      primary:
        persistence:
          enabled: true
          existingClaim: authentik-postgresql-data
          storageClass: longhorn
          size: 20Gi
          annotations:
            longhorn.io/volume-name: authentik-postgresql-data
            longhorn.io/backup: "true"
          labels:
            app.kubernetes.io/name: authentik-postgresql
            app.kubernetes.io/instance: authentik
            app.kubernetes.io/component: database
          accessModes:
            - ReadWriteOnce
    redis:
      enabled: true
      architecture: standalone
      auth:
        enabled: false
      master:
        persistence:
          enabled: true
          storageClass: longhorn
          size: 8Gi
          annotations:
            longhorn.io/backup: "true"
          labels:
            app.kubernetes.io/name: authentik-redis
            app.kubernetes.io/instance: authentik
            app.kubernetes.io/component: cache
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 1Gi
        configuration: |-
          # Redis configuration for better durability and resilience
          # Enable AOF with safer settings
          appendonly yes
          appendfsync everysec
          no-appendfsync-on-rewrite no
          auto-aof-rewrite-percentage 100
          auto-aof-rewrite-min-size 64mb

          # Disable RDB persistence (AOF is sufficient)
          save ""

          # Memory management
          maxmemory 512mb
          maxmemory-policy allkeys-lru

          # Disable dangerous commands
          rename-command FLUSHDB ""
          rename-command FLUSHALL ""
          rename-command DEBUG ""
          rename-command CONFIG ""

          # Logging
          loglevel notice

          # Network settings
          tcp-keepalive 300
          timeout 0

          # Persistence settings for better durability
          stop-writes-on-bgsave-error yes
          rdbcompression yes
          rdbchecksum yes

    server:
      replicas: 2
      resources:
        requests:
          cpu: 250m
          memory: 1Gi
        limits:
          cpu: 1000m
          memory: 4Gi
      volumes:
        - name: authentik-secrets
          secret:
            secretName: authentik-secrets
        - name: blueprints-sidecar
          emptyDir: {}
      volumeMounts:
        - name: authentik-secrets
          mountPath: /authentik-secrets
          readOnly: true
        - name: blueprints-sidecar
          mountPath: /blueprints
          readOnly: true
      extraContainers:
        - name: sidecar-blueprints
          # renovate: datasource=docker registryUrl=ghcr.io depName=kiwigrid/k8s-sidecar
          image: "ghcr.io/kiwigrid/k8s-sidecar:1.30.10"
          env:
            - name: "LABEL"
              value: "authentik_blueprint"
            - name: "LABEL_VALUE"
              value: "true"
            - name: "NAMESPACE"
              value: "ALL"
            - name: "FOLDER"
              value: "/blueprints"
          volumeMounts:
            - name: blueprints-sidecar
              mountPath: /blueprints
          resources:
            requests:
              cpu: 10m
              memory: 128Mi
            limits:
              memory: 256Mi

    worker:
      replicas: 2
      resources:
        requests:
          cpu: 250m
          memory: 512Mi
        limits:
          cpu: 500m
          memory: 2Gi
      volumes:
        - name: authentik-secrets
          secret:
            secretName: authentik-secrets
        - name: blueprints-sidecar
          emptyDir: {}
      volumeMounts:
        - name: authentik-secrets
          mountPath: /authentik-secrets
          readOnly: true
        - name: blueprints-sidecar
          mountPath: /blueprints
          readOnly: true
      extraContainers:
        - name: sidecar-blueprints
          # renovate: datasource=docker registryUrl=ghcr.io depName=kiwigrid/k8s-sidecar
          image: "ghcr.io/kiwigrid/k8s-sidecar:1.30.10"
          env:
            - name: "LABEL"
              value: "authentik_blueprint"
            - name: "LABEL_VALUE"
              value: "true"
            - name: "NAMESPACE"
              value: "ALL"
            - name: "FOLDER"
              value: "/blueprints"
          volumeMounts:
            - name: blueprints-sidecar
              mountPath: /blueprints
          resources:
            requests:
              cpu: 10m
              memory: 128Mi
            limits:
              memory: 256Mi
