---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: trivy-operator
  namespace: trivy-system
spec:
  interval: 1h
  chart:
    spec:
      chart: trivy-operator
      # renovate: datasource=helm registryUrl=https://aquasecurity.github.io/helm-charts/ depName=trivy-operator
      version: "0.31.0"
      sourceRef:
        kind: HelmRepository
        name: aqua
        namespace: flux-system
  values:
    service:
      headless: false
      metricsPort: 80
    serviceMonitor:
      enabled: true
      labels:
        release: kube-prometheus-stack
    operator:
      # Enable all metrics for the dashboard
      metricsFindingsEnabled: true
      metricsVulnIdEnabled: true
      metricsExposedSecretInfo: true
      metricsConfigAuditInfo: true
      metricsRbacAssessmentInfo: true
      metricsInfraAssessmentInfo: true
      metricsImageInfo: true
      metricsClusterComplianceInfo: true
      # Webhook configuration - send reports to Alloy for Loki ingestion
      webhookBroadcastURL: "http://alloy.alloy-system.svc:8080/loki/api/v1/raw"
      webhookBroadcastTimeout: 30s
      webhookSendDeletedReports: true
    # Alternate report storage - prevents CRD creation in etcd
    # Reports are sent to Loki via webhook; local PVC is just scratch space
    alternateReportStorage:
      enabled: true
      mountPath: /mnt/data/trivy-operator
      storage: 1Gi
      podSecurityContext:
        runAsUser: 10000
        fsGroup: 10000
    # Configure node-collector to comply with Pod Security Standards
    nodeCollector:
      # Set security context for node-collector pods
      scanJobPodTemplatePodSecurityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      scanJobPodTemplateContainerSecurityContext:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: false
        capabilities:
          drop: ["ALL"]
      # Talos compatibility: exclude problematic volumeMounts/volumes
      # References:
      # - https://github.com/aquasecurity/trivy-operator/discussions/1326
      # - https://github.com/aquasecurity/trivy-operator/issues/2566
      # Override default volumes to exclude /etc/systemd and /lib/systemd for Talos
      volumes:
        - name: var-lib-etcd
          hostPath:
            path: /var/lib/etcd
        - name: var-lib-kubelet
          hostPath:
            path: /var/lib/kubelet
        - name: var-lib-kube-scheduler
          hostPath:
            path: /var/lib/kube-scheduler
        - name: var-lib-kube-controller-manager
          hostPath:
            path: /var/lib/kube-controller-manager
        - name: etc-kubernetes
          hostPath:
            path: /etc/kubernetes
        - name: etc-cni-netd
          hostPath:
            path: /etc/cni/net.d/
      volumeMounts:
        - name: var-lib-etcd
          mountPath: /var/lib/etcd
          readOnly: true
        - name: var-lib-kubelet
          mountPath: /var/lib/kubelet
          readOnly: true
        - name: var-lib-kube-scheduler
          mountPath: /var/lib/kube-scheduler
          readOnly: true
        - name: var-lib-kube-controller-manager
          mountPath: /var/lib/kube-controller-manager
          readOnly: true
        - name: etc-kubernetes
          mountPath: /etc/kubernetes
          readOnly: true
        - name: etc-cni-netd
          mountPath: /etc/cni/net.d/
          readOnly: true
    trivy:
      # Remove --list-all-pkgs to reduce report size significantly
      listAllPackages: false
      # Increase timeout
      timeout: 10m
      # Skip Java DB update to speed up scans
      skipJavaDBUpdate: true
    resources:
      limits:
        cpu: 400m
        memory: 1Gi
      requests:
        cpu: 200m
        memory: 512Mi
