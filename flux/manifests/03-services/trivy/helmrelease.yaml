---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: trivy-operator
  namespace: trivy-system
spec:
  interval: 1h
  chart:
    spec:
      chart: trivy-operator
      # renovate: datasource=helm registryUrl=https://aquasecurity.github.io/helm-charts/ depName=trivy-operator
      version: "0.30.0"
      sourceRef:
        kind: HelmRepository
        name: aqua
        namespace: flux-system
  values:
    service:
      headless: false
      metricsPort: 80
    serviceMonitor:
      enabled: true
      labels:
        release: kube-prometheus-stack
    operator:
      # Enable all metrics for the dashboard
      metricsFindingsEnabled: true
      metricsVulnIdEnabled: true
      metricsExposedSecretInfo: true
      metricsConfigAuditInfo: true
      metricsRbacAssessmentInfo: true
      metricsInfraAssessmentInfo: true
      metricsImageInfo: true
      metricsClusterComplianceInfo: true
    # Configure node-collector to comply with Pod Security Standards
    nodeCollector:
      # Set security context for node-collector pods
      scanJobPodTemplatePodSecurityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      scanJobPodTemplateContainerSecurityContext:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: false
        capabilities:
          drop: ["ALL"]
      # Talos compatibility: exclude problematic volumeMounts/volumes
      # Reference: https://github.com/aquasecurity/trivy-operator/discussions/1326
      existingSecret: ""
      scanJobPodTemplateVolumes: []
      scanJobPodTemplateVolumeMounts: []
    trivy:
      # Remove --list-all-pkgs to reduce report size significantly
      listAllPackages: false
      # Increase timeout
      timeout: 10m
      # Skip Java DB update to speed up scans
      skipJavaDBUpdate: true
    resources:
      limits:
        cpu: 400m
        memory: 1Gi
      requests:
        cpu: 200m
        memory: 512Mi
