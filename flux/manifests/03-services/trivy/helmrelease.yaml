---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: trivy-operator
  namespace: trivy-system
spec:
  interval: 1h
  chart:
    spec:
      chart: trivy-operator
      # renovate: datasource=helm registryUrl=https://aquasecurity.github.io/helm-charts/ depName=trivy-operator
      version: "0.30.0"
      sourceRef:
        kind: HelmRepository
        name: aqua
        namespace: flux-system
  values:
    service:
      headless: false
      metricsPort: 80
    serviceMonitor:
      enabled: true
      labels:
        release: kube-prometheus-stack
    operator:
      # Enable all metrics for the dashboard
      metricsFindingsEnabled: true
      metricsVulnIdEnabled: true
      metricsExposedSecretInfo: true
      metricsConfigAuditInfo: true
      metricsRbacAssessmentInfo: true
      metricsInfraAssessmentInfo: true
      metricsImageInfo: true
      metricsClusterComplianceInfo: true
    # Configure node-collector to comply with Pod Security Standards
    nodeCollector:
      # Set security context for node-collector pods
      scanJobPodTemplatePodSecurityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      scanJobPodTemplateContainerSecurityContext:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: false
        capabilities:
          drop: ["ALL"]
    resources:
      limits:
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi
