# Flyte Workflow Orchestrator

Kubernetes-native workflow orchestration platform for machine learning and data processing workloads.

> **Navigation**: [‚Üê Back to Services README](../README.md)

## Documentation

- **[Flyte Official Documentation](https://www.union.ai/docs/v1/flyte/user-guide/)** - Primary documentation source
- **[Flyte GitHub Repository](https://github.com/flyteorg/flyte)** - Source code and issues
- **[Flyte Helm Charts](https://github.com/flyteorg/flyte/tree/master/charts)** - Deployment configuration

## Overview

This deployment includes:

- **FlyteAdmin**: Control plane service managing workflow executions and metadata
- **FlytePropeller**: Kubernetes operator executing workflows and managing task lifecycle
- **DataCatalog**: Metadata service for datasets and artifacts
- **FlyteConsole**: Web UI for workflow visualization and management
- **PostgreSQL Database**: CloudNativePG-managed cluster for metadata storage
- **Authentik SSO Integration**: OIDC authentication for secure access

## Configuration

### 1Password Secrets

Create a 1Password item:

#### flyte-secrets (`vaults/Secrets/items/flyte-secrets`)

- `username`: Database username for Flyte (typically `flyte`)
- `password`: Database password for Flyte
- `oidc-client-id`: Authentik OIDC client ID (generated by Authentik blueprint)
- `oidc-client-secret`: Authentik OIDC client secret (generated by Authentik blueprint)
- `minio-username`: MinIO root username
- `minio-password`: MinIO root password

### Storage

- **Database Storage**: 20Gi Longhorn volume for PostgreSQL metadata
- **Workflow Artifacts**: 50Gi Longhorn volume for workflow outputs and artifacts

### Access

- **External URL**: `https://flyte.gateway.services.apocrathia.com`
- **Internal Service**: `http://flyteconsole.flyte-system.svc.cluster.local:80`
- **Database**: `flyte-postgres-rw.flyte-system.svc.cluster.local:5432`

## Authentication

Authentication is handled through Authentik OIDC integration:

1. **OIDC Provider**: Authentik blueprint creates `flyte-oidc-provider`
2. **External Auth Server**: FlyteAdmin configured to use external OIDC provider
3. **Proper Routing**: HTTPRoute routes authentication endpoints (`/login`, `/callback`, `/me`) to FlyteAdmin
4. **Automatic Setup**: Client configuration and redirect URIs configured automatically
5. **Clean Deployment**: Works with Authentik from day one

## Security Considerations

- **SSO Integration**: Complete authentication through Authentik OIDC
- **Database Security**: PostgreSQL credentials managed through 1Password
- **Network Policies**: Cilium NetworkPolicy for traffic control
- **RBAC**: Proper role-based access control for workflow execution

## Troubleshooting

### Common Issues

1. **Database Connection Issues**

   ```bash
   # Check PostgreSQL cluster status
   kubectl get cluster flyte-postgres -n flyte-system

   # Check database connectivity
   kubectl exec -it flyte-postgres-1 -n flyte-system -- psql -U flyte -d flyteadmin
   ```

2. **Authentication Problems**

   ```bash
   # Verify Authentik blueprint is applied
   kubectl get configmap authentik-blueprint-flyte -n authentik

   # Check OIDC provider configuration
   kubectl logs deployment/authentik-server -n authentik

   # Verify HTTPRoute routing (critical for OIDC)
   kubectl get httproute flyte -n flyte-system -o yaml

   # Check FlyteAdmin OIDC configuration
   kubectl get configmap flyte-admin-base-config -n flyte-system -o yaml | grep -A 20 "auth:"
   ```

3. **Empty Projects**

   ```bash
   # Projects are seeded empty by default
   # Register sample workflows from flytesnacks:
   git clone https://github.com/flyteorg/flytesnacks.git
   cd flytesnacks
   pyflyte register workflows --remote --project flytesnacks
   ```

4. **Workflow Execution Failures**

   ```bash
   # Check FlytePropeller logs
   kubectl logs deployment/flytepropeller -n flyte-system

   # Verify task pod status
   kubectl get pods -l flyte.org/workflow-execution -n flyte-system
   ```

### Health Checks

```bash
# Overall status
kubectl get pods,svc,pvc -n flyte-system

# Component-specific status
kubectl get pods -l app.kubernetes.io/name=flyteadmin -n flyte-system
kubectl get pods -l app.kubernetes.io/name=flytepropeller -n flyte-system
kubectl get pods -l app.kubernetes.io/name=datacatalog -n flyte-system
kubectl get pods -l app.kubernetes.io/name=flyteconsole -n flyte-system
```
