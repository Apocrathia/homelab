---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: mimir
  namespace: mimir-system
spec:
  interval: 5m
  chart:
    spec:
      chart: mimir-distributed
      # renovate: datasource=helm registryUrl=https://grafana.github.io/helm-charts depName=mimir-distributed
      version: "5.8.0"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
      interval: 1m
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3

  # Pull values from 1Password secret
  valuesFrom:
    - kind: Secret
      name: mimir-minio-credentials
      valuesKey: root_user
      targetPath: minio.rootUser
    - kind: Secret
      name: mimir-minio-credentials
      valuesKey: root_password
      targetPath: minio.rootPassword

  values:
    # Enable MinIO for object storage
    minio:
      enabled: true
      mode: standalone
      persistence:
        enabled: true
        storageClassName: longhorn
        size: 100Gi
        accessMode: ReadWriteOnce
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi

    # Configure Mimir for distributed mode
    global:
      clusterDomain: cluster.local
      dnsService: kube-dns
      dnsNamespace: kube-system

      # Increase series limits to handle Prometheus data
      runtimeConfig:
        overrides:
          anonymous:
            max_global_series_per_user: 1000000
            # Increase ingestion limits for high-volume metrics
            ingestion_rate: 100000
            ingestion_burst_size: 1000000
            # Increase other relevant limits
            max_series_per_query: 1000000
            max_query_parallelism: 32

    # Configure replication for 2-replica setup
    mimir:
      structuredConfig:
        ingester:
          ring:
            replication_factor: 2

    # Note: The chart automatically configures S3 storage when MinIO is enabled
    # No need to manually configure blocks_storage, ruler_storage, etc.
    # The chart uses the MinIO credentials from the minio section above

    # Resource configuration for Mimir components
    ingester:
      replicas: 2
      zoneAwareReplication:
        enabled: false # Disable zone awareness for simpler setup
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
        limits:
          cpu: 2000m
          memory: 4Gi
      persistentVolume:
        enabled: true
        storageClassName: longhorn
        size: 20Gi

    distributor:
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 1Gi
      # Increase ingestion rate limits to handle high-volume metrics
      extraArgs:
        distributor.ingestion-rate-limit: "100000"
        distributor.ingestion-burst-size: "1000000"

    querier:
      resources:
        requests:
          cpu: 200m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 2Gi

    store_gateway:
      replicas: 2
      zoneAwareReplication:
        enabled: false # Disable zone awareness for simpler setup
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 1Gi

    compactor:
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 1Gi

    # Enable the proper gateway (not just nginx)
    gateway:
      enabled: true
      enabledNonEnterprise: true # Enable gateway for non-enterprise
      replicas: 1
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 256Mi

    # Disable nginx since we're using the gateway
    nginx:
      enabled: false

    # Configure for remote write from Prometheus
    serviceMonitor:
      enabled: true
      interval: 30s
