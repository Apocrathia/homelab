---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: loki
  namespace: loki-system
spec:
  interval: 5m
  chart:
    spec:
      chart: loki
      # renovate: datasource=helm registryUrl=https://grafana.github.io/helm-charts depName=loki
      version: "6.42.0"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
      interval: 1m
  install:
    createNamespace: true
    remediation:
      retries: 3
    timeout: 10m
  upgrade:
    remediation:
      retries: 3
    timeout: 10m

  valuesFrom:
    - kind: Secret
      name: loki-secrets
      valuesKey: access-key-id
      targetPath: loki.storage.s3.accessKeyId
    - kind: Secret
      name: loki-secrets
      valuesKey: access-key-secret
      targetPath: loki.storage.s3.secretAccessKey

  values:
    # Loki configuration
    loki:
      # Storage configuration - using external MinIO
      storage:
        type: s3
        bucketNames:
          chunks: loki
          ruler: loki
          admin: loki
        s3:
          endpoint: "http://storage.services.apocrathia.com:9000"
          insecure: true
          s3ForcePathStyle: true
      # Disable query scheduler for homelab
      frontend:
        scheduler_address: ""
      frontend_worker:
        scheduler_address: ""

      # Authentication configuration (disabled for homelab)
      auth_enabled: false

      # Schema configuration
      schemaConfig:
        configs:
          - from: "2020-10-24"
            store: tsdb
            object_store: s3
            schema: v13
            index:
              prefix: loki_index_
              period: 24h

      # Common configuration
      commonConfig:
        path_prefix: /var/loki
        replication_factor: 2

      # Table manager for retention
      tableManager:
        retention_deletes_enabled: true
        retention_period: 744h # 31 days

      # Limits configuration
      limits_config:
        allow_structured_metadata: false

    # MinIO subchart disabled - using external MinIO
    minio:
      enabled: false

    # Write component configuration
    write:
      replicas: 2
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/component: write
                topologyKey: kubernetes.io/hostname

    # Resources for Loki components
    resources:
      limits:
        cpu: 1000m
        memory: 2Gi
      requests:
        cpu: 200m
        memory: 512Mi

    # Monitoring configuration
    serviceMonitor:
      enabled: true
      interval: 30s
      scrapeTimeout: 10s
      additionalLabels:
        release: prometheus

    # Security context
    securityContext:
      runAsNonRoot: true
      runAsUser: 10001
      fsGroup: 10001

    # Pod security context
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 10001
      fsGroup: 10001

    # Disable memcached caches for homelab (reduces memory usage)
    chunksCache:
      enabled: false
    resultsCache:
      enabled: false
