---
apiVersion: v1
kind: ConfigMap
metadata:
  name: tempo-grafana-datasource
  namespace: prometheus-system
  labels:
    app: kube-prometheus-stack-grafana
    grafana_datasource: "1"
data:
  tempo-datasource.yaml: |-
    apiVersion: 1
    datasources:
    - name: "Tempo"
      type: tempo
      uid: tempo
      url: http://tempo-gateway.tempo-system.svc:80
      access: proxy
      isDefault: false
      jsonData:
        httpMethod: GET
        serviceMap:
          datasourceUid: prometheus
        nodeGraph:
          enabled: true
        tracesToLogsV2:
          datasourceUid: loki
          spanStartTimeShift: "-1h"
          spanEndTimeShift: "1h"
          filterByTraceID: true
          filterBySpanID: false
          customQuery: true
          query: '{namespace="$${__span.tags["service.namespace"]}"} | json'
        tracesToMetrics:
          datasourceUid: prometheus
          spanStartTimeShift: "-1h"
          spanEndTimeShift: "1h"
          tags:
            - key: service.name
              value: service
        lokiSearch:
          datasourceUid: loki
