---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: alloy
  namespace: alloy-system
spec:
  interval: 5m
  chart:
    spec:
      chart: alloy
      # renovate: datasource=helm registryUrl=https://grafana.github.io/helm-charts depName=alloy
      version: "1.5.1"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
      interval: 1m
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    # Alloy configuration for log collection
    alloy:
      configMap:
        create: false
        name: alloy-config
        key: config.alloy

      # Resources
      resources:
        requests:
          cpu: 250m
          memory: 256Mi
        limits:
          cpu: 1000m
          memory: 1Gi

      # Container security context
      securityContext:
        runAsNonRoot: true
        runAsUser: 10001
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        capabilities:
          drop: ["ALL"]

      # Extra ports for webhook receivers
      extraPorts:
        - name: trivy-webhook
          port: 8080
          targetPort: 8080
          protocol: TCP

      # Extra volume mounts for WAL storage
      mounts:
        extra:
          - name: alloy-wal
            mountPath: /tmp/alloy

    # RBAC configuration - minimal permissions for secure log collection via Kubernetes API
    rbac:
      create: true
      rules:
        - apiGroups: [""]
          resources: ["pods", "pods/log"]
          verbs: ["get", "list", "watch"]
        - apiGroups: [""]
          resources: ["namespaces"]
          verbs: ["get", "list"]
        - apiGroups: [""]
          resources: ["events"]
          verbs: ["get", "list", "watch"]
        - apiGroups: [""]
          resources: ["services"]
          verbs: ["get", "list", "watch"]

    # Service account configuration
    serviceAccount:
      create: true
      annotations: {}

    # Global pod security context
    global:
      podSecurityContext:
        runAsNonRoot: true
        runAsUser: 10001
        fsGroup: 10001

    # Node selector for all nodes
    nodeSelector: {}

    # Tolerations for all nodes
    tolerations: []

    # Affinity for all nodes
    affinity: {}

    # Controller configuration
    controller:
      # Extra volumes for WAL storage (emptyDir for temporary data)
      volumes:
        extra:
          - name: alloy-wal
            emptyDir: {}
