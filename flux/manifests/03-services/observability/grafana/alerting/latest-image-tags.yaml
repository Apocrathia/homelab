---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaFolder
metadata:
  name: security-alerts
  namespace: prometheus-system
spec:
  title: Security
  instanceSelector:
    matchLabels:
      app.kubernetes.io/name: grafana
      app.kubernetes.io/instance: kube-prometheus-stack

---
# Real-time alerts for NEW containers using :latest (hourly check)
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaAlertRuleGroup
metadata:
  name: latest-image-tags-realtime
  namespace: prometheus-system
spec:
  name: Latest Image Tags - Realtime
  folderRef: security-alerts
  interval: 1h
  instanceSelector:
    matchLabels:
      app.kubernetes.io/name: grafana
      app.kubernetes.io/instance: kube-prometheus-stack
  rules:
    - uid: new-latest-image-tag-alert
      title: New Container Using 'latest' Image Tag
      condition: C
      for: 0s
      execErrState: Alerting
      noDataState: OK
      data:
        - refId: A
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: prometheus
          model:
            datasource:
              type: prometheus
              uid: prometheus
            expr: |
              group by (pod, namespace, image) (
                kube_pod_container_info{image=~".*:latest$"}
                unless on(pod, namespace, container, image)
                kube_pod_container_info{image=~".*:latest$"} offset 2h
              )
            intervalMs: 1000
            maxDataPoints: 43200
            refId: A
        - refId: B
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: __expr__
          model:
            datasource:
              type: __expr__
              uid: __expr__
            type: reduce
            reducer: last
            expression: A
            refId: B
        - refId: C
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: __expr__
          model:
            datasource:
              type: __expr__
              uid: __expr__
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  type: gt
                  params:
                    - 0
                operator:
                  type: and
                query:
                  params: []
                reducer:
                  type: last
                  params: []
                type: query
      annotations:
        summary: "ðŸ†• {{ $labels.namespace }}/{{ $labels.pod }} using :latest tag"
        description: "Image: {{ $labels.image }}"
      labels:
        severity: warning
        team: platform
        alert_type: realtime

---
# Daily report of ALL containers using :latest
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaAlertRuleGroup
metadata:
  name: latest-image-tags-report
  namespace: prometheus-system
spec:
  name: Latest Image Tags - Daily Report
  folderRef: security-alerts
  interval: 24h
  instanceSelector:
    matchLabels:
      app.kubernetes.io/name: grafana
      app.kubernetes.io/instance: kube-prometheus-stack
  rules:
    - uid: latest-image-tags-daily-report
      title: "Daily Report: Container Using 'latest' Image Tag"
      condition: C
      for: 0s
      execErrState: Alerting
      noDataState: OK
      data:
        - refId: A
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: prometheus
          model:
            datasource:
              type: prometheus
              uid: prometheus
            expr: |
              group by (pod, namespace, image) (
                kube_pod_container_info{image=~".*:latest$"}
              )
            intervalMs: 1000
            maxDataPoints: 43200
            refId: A
        - refId: B
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: __expr__
          model:
            datasource:
              type: __expr__
              uid: __expr__
            type: reduce
            reducer: last
            expression: A
            refId: B
        - refId: C
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: __expr__
          model:
            datasource:
              type: __expr__
              uid: __expr__
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  type: gt
                  params:
                    - 0
                operator:
                  type: and
                query:
                  params: []
                reducer:
                  type: last
                  params: []
                type: query
      annotations:
        summary: "ðŸ“‹ {{ $labels.namespace }}/{{ $labels.pod }} using :latest tag"
        description: "Image: {{ $labels.image }}"
      labels:
        severity: info
        team: platform
        alert_type: report

---
# Dedicated contact point for :latest image alerts with custom formatting
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaContactPoint
metadata:
  name: discord-latest-images
  namespace: prometheus-system
spec:
  name: Discord - Latest Images
  type: discord
  instanceSelector:
    matchLabels:
      app.kubernetes.io/name: grafana
      app.kubernetes.io/instance: kube-prometheus-stack
  settings:
    title: "{{ .CommonLabels.alertname }}{{ if gt (len .Alerts) 1 }} ({{ len .Alerts }} instances){{ end }}"
    message: |
      {{ range .Alerts }}â€¢ **{{ .Labels.namespace }}/{{ .Labels.pod }}**
        `{{ .Labels.image }}`
      {{ end }}
  valuesFrom:
    - targetPath: url
      valueFrom:
        secretKeyRef:
          name: grafana-secrets
          key: discord-webhook-url

---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaNotificationPolicy
metadata:
  name: latest-image-tags-policy
  namespace: prometheus-system
spec:
  instanceSelector:
    matchLabels:
      app.kubernetes.io/name: grafana
      app.kubernetes.io/instance: kube-prometheus-stack
  route:
    receiver: Discord - Latest Images
    group_by:
      - alertname
    group_wait: 30s
    group_interval: 5m
    repeat_interval: 4h
