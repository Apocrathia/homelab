# External Secrets Operator

External Secrets Operator is a Kubernetes operator that integrates external secret management systems with Kubernetes, enabling bidirectional secret synchronization between your cluster and external secret stores.

> **Navigation**: [← Back to Services README](../README.md)

## Documentation

- **[External Secrets Documentation](https://external-secrets.io/latest/)** - Primary documentation source
- **[GitHub Repository](https://github.com/external-secrets/external-secrets)** - Source code and issues

## Overview

This deployment installs the External Secrets Operator using Helm, which provides:

- **Bidirectional Secret Sync**: Pull secrets from external systems into Kubernetes AND push generated/rotated secrets back to external systems
- **1Password Integration**: Primary use case for writing back generated secrets to 1Password
- **Multiple Backend Support**: AWS Secrets Manager, HashiCorp Vault, Azure Key Vault, and more
- **Automatic Secret Rotation**: Seamless handling of secret rotation workflows

## Primary Use Case: 1Password Write-Back

The main use case in this homelab is to **write back secrets to 1Password** when they are:

- Generated by applications running in the cluster
- Rotated by certificate managers or other operators
- Created by CI/CD pipelines or automation

### Workflow Example

1. **Certificate Generation**: Cert Manager generates a new TLS certificate
2. **Secret Creation**: The certificate is stored as a Kubernetes Secret
3. **Push to 1Password**: External Secrets Operator detects the new/updated secret
4. **1Password Sync**: The secret is automatically pushed to 1Password Connect
5. **Centralized Management**: All secrets are now available in 1Password for backup, audit, and access

## Configuration

The operator is configured with:

- **CRDs**: Automatically installed for all External Secrets resources
- **Resource Limits**: CPU 200m, Memory 256Mi (appropriate for homelab usage)
- **Single Replica**: Efficient resource usage for homelab environment
- **GitHub Container Registry**: Uses `ghcr.io` images for reliable access

## Key Resources

### SecretStore/ClusterSecretStore

- **Purpose**: Configure connection to 1Password Connect or other secret backends
- **Scope**: SecretStore (namespace-scoped) or ClusterSecretStore (cluster-wide)

### ExternalSecret

- **Purpose**: Pull secrets from external systems into Kubernetes
- **Direction**: External → Kubernetes

### PushSecret (Primary Use Case)

- **Purpose**: Push secrets from Kubernetes to external systems
- **Direction**: Kubernetes → 1Password
- **Use Cases**: Certificate rotation, generated passwords, API keys

## 1Password Integration

The External Secrets Operator is pre-configured with a ClusterSecretStore that connects to the existing 1Password Connect deployment in this homelab.

### Pre-configured Components

- **ClusterSecretStore**: `1password-connect` - Automatically deployed and configured
- **1Password Connect**: Already running in the `onepassword-system` namespace
- **Authentication**: Uses the existing `onepassword-token` secret

### Usage

To enable 1Password write-back functionality, simply create PushSecret resources that reference the pre-configured ClusterSecretStore:

### Example PushSecret for Wildcard Certificate

Based on the existing cert-manager configuration in this homelab:

```yaml
apiVersion: external-secrets.io/v1
kind: PushSecret
metadata:
  name: wildcard-apocrathia-com-push
  namespace: cert-manager
spec:
  secretStoreRefs:
    - name: 1password-connect
      kind: ClusterSecretStore
  selector:
    secret:
      name: wildcard-apocrathia-com-tls
  data:
    - match:
        secretKey: tls.crt
        remoteRef:
          key: "vaults/Secrets/items/wildcard-apocrathia-com-cert"
          property: "certificate"
    - match:
        secretKey: tls.key
        remoteRef:
          key: "vaults/Secrets/items/wildcard-apocrathia-com-cert"
          property: "private_key"
```

### Example PushSecret for Generated Application Secrets

For secrets generated by applications (like database passwords, API keys):

```yaml
apiVersion: external-secrets.io/v1
kind: PushSecret
metadata:
  name: app-generated-secrets
  namespace: my-app
spec:
  secretStoreRefs:
    - name: 1password-connect
      kind: ClusterSecretStore
  selector:
    secret:
      name: my-app-generated-secrets
  data:
    - match:
        secretKey: database-password
        remoteRef:
          key: "vaults/Secrets/items/my-app-database"
          property: "password"
    - match:
        secretKey: api-key
        remoteRef:
          key: "vaults/Secrets/items/my-app-api-keys"
          property: "api_key"
```

## Security Considerations

- **RBAC**: Operator runs with minimal required permissions
- **Network Policies**: Traffic is isolated to necessary endpoints
- **Secret Encryption**: All secrets are encrypted in transit and at rest
- **Audit Trail**: All secret operations are logged for compliance

## Monitoring

The operator provides metrics and logs for:

- Secret sync operations (success/failure)
- Push/pull operations to external systems
- Authentication and authorization events
- Performance metrics for troubleshooting
