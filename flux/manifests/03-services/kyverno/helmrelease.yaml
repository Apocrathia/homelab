---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kyverno
  namespace: kyverno
spec:
  interval: 30m
  chart:
    spec:
      chart: kyverno
      # renovate: datasource=helm registryUrl=https://kyverno.github.io/kyverno depName=kyverno
      version: "3.6.1"
      sourceRef:
        kind: HelmRepository
        name: kyverno
        namespace: flux-system
      interval: 30m
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    crds:
      install: true
    extraArgs:
      - --autogenInternals=false
      - --leaderElectionLeaseDuration=30s
      - --leaderElectionRenewDeadline=20s
      - --leaderElectionRetryPeriod=5s
    config:
      # Remove ReplicaSet filters to allow cleanup policies to work
      resourceFiltersExclude:
        - "[ReplicaSet,*,*]"
        - "[ReplicaSet/?*,*,*]"
    global:
      image:
        registry: ghcr.io
    rbac:
      extraResources: &commonResources # Read access to all resources
        - apiGroups: ["*"]
          resources: ["*"]
          verbs: ["get", "list", "watch"]
        # Allow to modify cert-manager ClusterIssuers
        - apiGroups: ["cert-manager.io"]
          resources: ["ClusterIssuer"]
          verbs: ["get", "list", "watch", "update", "patch"]
      clusterRole:
        extraResources: *commonResources
      admissionController:
        clusterRole:
          extraResources: *commonResources
      backgroundController:
        clusterRole:
          extraResources: *commonResources
      reportsController:
        clusterRole:
          extraResources: *commonResources
      cleanupController:
        clusterRole:
          extraResources: *commonResources
    admissionController:
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
      startupProbe:
        initialDelaySeconds: 10
        periodSeconds: 5
        timeoutSeconds: 5
        failureThreshold: 12
      readinessProbe:
        initialDelaySeconds: 15
        periodSeconds: 15
        timeoutSeconds: 10
        failureThreshold: 9
      livenessProbe:
        initialDelaySeconds: 30
        periodSeconds: 10
        timeoutSeconds: 10
        failureThreshold: 3
    cleanupController:
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
