---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kyverno
  namespace: kyverno
spec:
  interval: 30m
  chart:
    spec:
      chart: kyverno
      # renovate: datasource=helm registryUrl=https://kyverno.github.io/kyverno depName=kyverno
      version: "3.6.0"
      sourceRef:
        kind: HelmRepository
        name: kyverno
        namespace: flux-system
      interval: 30m
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    extraArgs:
      - --autogenInternals=false
    config:
      # Remove ReplicaSet filters to allow cleanup policies to work
      resourceFiltersExclude:
        - "[ReplicaSet,*,*]"
        - "[ReplicaSet/?*,*,*]"
    global:
      image:
        registry: ghcr.io
    rbac:
      extraResources: &commonResources # Read access to all resources
        - apiGroups: ["*"]
          resources: ["*"]
          verbs: ["get", "list", "watch"]
        # Allow to modify cert-manager ClusterIssuers
        - apiGroups: ["cert-manager.io"]
          resources: ["ClusterIssuer"]
          verbs: ["get", "list", "watch", "update", "patch"]
      clusterRole:
        extraResources: *commonResources
      admissionController:
        clusterRole:
          extraResources: *commonResources
      backgroundController:
        clusterRole:
          extraResources: *commonResources
      reportsController:
        clusterRole:
          extraResources: *commonResources
