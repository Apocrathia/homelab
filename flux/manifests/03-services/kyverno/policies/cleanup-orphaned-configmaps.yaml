---
apiVersion: kyverno.io/v2
kind: ClusterCleanupPolicy
metadata:
  name: cleanup-orphaned-configmaps
  annotations:
    policies.kyverno.io/title: Cleanup Orphaned ConfigMaps
    policies.kyverno.io/category: Other
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: ConfigMap
    kyverno.io/kyverno-version: 1.11.1
    policies.kyverno.io/minversion: 1.9.0
    kyverno.io/kubernetes-version: "1.27"
    policies.kyverno.io/description: >-
      Cleans up ConfigMaps without owner references that are older than 30 days
      to prevent etcd bloat from accumulating orphaned configuration resources.
      Only targets ConfigMaps with no owner references to avoid disrupting
      active workloads.
spec:
  match:
    any:
      - resources:
          kinds:
            - ConfigMap
  exclude:
    any:
      - resources:
          namespaces:
            - kube-system
            - kyverno
      - resources:
          # Exclude system-managed ConfigMaps
          names:
            - "kube-root-ca.crt"
  conditions:
    all:
      - key: "{{ time_diff(target.metadata.creationTimestamp, time_now_utc()) }}"
        operator: GreaterThan
        value: "720h0m0s"
    # Only clean up ConfigMaps without owner references
    any:
      - key: "{{ (target.metadata.ownerReferences || []) | length(@) }}"
        operator: Equals
        value: 0
  schedule: "0 9 * * *" # 0200 America/Denver (UTC-7)
