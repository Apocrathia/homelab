---
apiVersion: kyverno.io/v2
kind: ClusterCleanupPolicy
metadata:
  name: cleanup-orphaned-secrets
  annotations:
    policies.kyverno.io/title: Cleanup Orphaned Secrets
    policies.kyverno.io/category: Other
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Secret
    kyverno.io/kyverno-version: 1.11.1
    policies.kyverno.io/minversion: 1.9.0
    kyverno.io/kubernetes-version: "1.27"
    policies.kyverno.io/description: >-
      Cleans up Secrets without owner references that are older than 30 days
      to prevent etcd bloat from accumulating orphaned secret resources.
      Only targets Secrets with no owner references to avoid disrupting
      active workloads. Excludes service account tokens and other system secrets.
spec:
  match:
    any:
      - resources:
          kinds:
            - Secret
  exclude:
    any:
      - resources:
          namespaces:
            - kube-system
            - kyverno
  conditions:
    all:
      - key: "{{ time_diff(target.metadata.creationTimestamp, time_now_utc()) }}"
        operator: GreaterThan
        value: "720h0m0s"
      # Exclude service account token secrets
      - key: "{{ target.type }}"
        operator: NotEquals
        value: "kubernetes.io/service-account-token"
    # Only clean up Secrets without owner references
    any:
      - key: "{{ (target.metadata.ownerReferences || []) | length(@) }}"
        operator: Equals
        value: 0
  schedule: "0 2 * * *"
