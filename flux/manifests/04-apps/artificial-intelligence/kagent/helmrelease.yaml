---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kagent
  namespace: kagent
spec:
  interval: 30m
  dependsOn:
    - name: kagent-crds
      namespace: kagent
  chart:
    spec:
      chart: kagent
      # renovate: datasource=docker depName=ghcr.io/kagent-dev/kagent/helm/kagent
      version: "0.7.7"
      sourceRef:
        kind: HelmRepository
        name: kagent
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false

  # Pull database URL from secret (contains password)
  valuesFrom:
    - kind: Secret
      name: kagent-secrets
      valuesKey: postgres-url
      targetPath: database.postgres.url

  values:
    # Use ghcr.io for release images (default cr.kagent.dev is for dev)
    registry: ghcr.io

    database:
      type: postgres
      # URL injected via valuesFrom from kagent-secrets.postgres-url

    controller:
      replicas: 1
      loglevel: "info"

      # Watch all namespaces for Agent/MCPServer CRDs
      watchNamespaces: []

      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 1
          memory: 512Mi

    ui:
      replicas: 1
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
      service:
        type: ClusterIP
        ports:
          port: 8080
          targetPort: 8080

    # Using LiteLLM as OpenAI-compatible proxy
    # Model is required - agents can create their own ModelConfig for specific models
    providers:
      default: openAI
      openAI:
        provider: OpenAI
        model: "qwen3" # Need a model capable of handling tools.
        apiKeySecretRef: kagent-secrets
        apiKeySecretKey: litellm-api-key
        config:
          baseUrl: "http://litellm.litellm.svc.cluster.local:4000/v1"

    # Enable kmcp
    kmcp:
      enabled: true

    # Enable built-in tools
    kagent-tools:
      enabled: true

    # Enable MCP tool integrations
    tools:
      grafana-mcp:
        enabled: true
        image:
          # Use official Grafana image instead of kagent's default mcp/grafana:latest
          registry: docker.io
          repository: grafana/mcp-grafana
          # renovate: datasource=docker depName=docker.io/grafana/mcp-grafana
          tag: "0.7.10"
          pullPolicy: IfNotPresent
      querydoc:
        enabled: true

    # Enable system agents
    agents:
      k8s-agent:
        enabled: true
      kgateway-agent:
        enabled: false
      istio-agent:
        enabled: false
      promql-agent:
        enabled: true
      observability-agent:
        enabled: true
      argo-rollouts-agent:
        enabled: false
      helm-agent:
        enabled: true
      cilium-policy-agent:
        enabled: true
      cilium-manager-agent:
        enabled: true
      cilium-debug-agent:
        enabled: true

    otel:
      tracing:
        enabled: false
      logging:
        enabled: true
