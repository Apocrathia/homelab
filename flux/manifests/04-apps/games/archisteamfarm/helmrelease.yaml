---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: archisteamfarm
  namespace: archisteamfarm
spec:
  interval: 15m
  chart:
    spec:
      chart: ./helm/generic-app
      # renovate: datasource=git-tags depName=https://gitlab.com/Apocrathia/homelab.git
      version: "0.0.36"
      sourceRef:
        kind: GitRepository
        name: homelab
        namespace: flux-system
      interval: 5m
  values:
    app:
      name: archisteamfarm
      # renovate: datasource=docker depName=ghcr.io/justarchinet/archisteamfarm
      image: ghcr.io/justarchinet/archisteamfarm:6.3.0.1
      container:
        name: archisteamfarm
        port: 1242
        env:
          - name: TZ
            value: "America/Denver"
      service:
        port: 1242
        targetPort: 1242
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        readOnlyRootFilesystem: false
        runAsNonRoot: true
        allowPrivilegeEscalation: false
      resources:
        requests:
          cpu: 200m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 1Gi
      volumeMounts:
        - name: config
          mountPath: /app/config
        - name: plugins
          mountPath: /app/plugins
      volumes:
        emptyDir:
          - name: tmp
            mountPath: /tmp
      initContainers:
        - name: copy-config
          # renovate: datasource=docker registryUrl=https://public.ecr.aws depName=docker/library/alpine
          image: public.ecr.aws/docker/library/alpine:3.22.2
          command: ["sh", "-c"]
          args:
            - |
              echo "Copying secrets to config volume"
              mkdir -p /app/config
              # Remove only empty/corrupted database files (preserve files with data)
              find /app/config -name "*.db" -size 0 -delete
              echo "$$ASF_JSON" > /app/config/ASF.json
              echo "$$IPC_CONFIG" > /app/config/IPC.config
              echo "$$APOCRATHIA_JSON" > /app/config/Apocrathia.json
              echo "$$FREEGAMES_CONFIG" > /app/config/freegames.json.config
              ls -la /app/config
          env:
            - name: ASF_JSON
              valueFrom:
                secretKeyRef:
                  name: archisteamfarm-secrets
                  key: ASF.json
            - name: IPC_CONFIG
              valueFrom:
                secretKeyRef:
                  name: archisteamfarm-secrets
                  key: IPC.config
            - name: APOCRATHIA_JSON
              valueFrom:
                secretKeyRef:
                  name: archisteamfarm-secrets
                  key: Apocrathia.json
            - name: FREEGAMES_CONFIG
              valueFrom:
                secretKeyRef:
                  name: archisteamfarm-secrets
                  key: freegames.json.config
          volumeMounts:
            - name: config
              mountPath: /app/config
        - name: install-plugins
          # renovate: datasource=docker registryUrl=https://public.ecr.aws depName=docker/library/alpine
          image: public.ecr.aws/docker/library/alpine:3.22.2
          securityContext:
            runAsUser: 0
            runAsGroup: 0
            runAsNonRoot: false
            readOnlyRootFilesystem: false
          command: ["sh", "-c"]
          args:
            - |
              set -e
              echo "Installing ASF plugins..."
              mkdir -p /app/plugins/tmp
              cd /app/plugins/tmp

              # Clean up any existing plugin directories to avoid duplicates
              rm -rf /app/plugins/FreePackages /app/plugins/ASFFreeGames

              # Install FreePackages plugin
              echo "Downloading FreePackages plugin..."
              if wget -q -O FreePackages.zip "https://github.com/Citrinate/FreePackages/releases/latest/download/FreePackages.zip"; then
                # Extract to temp location first to handle nested directory structure
                unzip -o -q FreePackages.zip -d /app/plugins/tmp
                # Remove zip file
                rm -f FreePackages.zip
                # Move contents to plugin directory (handle both flat and nested structures)
                if [ -d "/app/plugins/tmp/FreePackages" ]; then
                  # Zip contains FreePackages subdirectory
                  mv /app/plugins/tmp/FreePackages /app/plugins/
                else
                  # Zip contents are flat, create directory and move files
                  mkdir -p /app/plugins/FreePackages
                  mv /app/plugins/tmp/* /app/plugins/FreePackages/ 2>/dev/null || true
                fi
                echo "FreePackages plugin installed successfully"
              else
                echo "Error: Failed to download FreePackages plugin"
                exit 1
              fi

              # Install ASFFreeGames plugin
              echo "Downloading ASFFreeGames plugin..."
              mkdir -p /app/plugins/ASFFreeGames
              if wget -q -O /app/plugins/ASFFreeGames/ASFFreeGames.dll "https://github.com/maxisoft/ASFFreeGames/releases/latest/download/ASFFreeGames.dll"; then
                echo "ASFFreeGames plugin installed successfully"
              else
                echo "Error: Failed to download ASFFreeGames plugin"
                exit 1
              fi

              # Set ownership to match main container (user 1000:1000)
              chown -R 1000:1000 /app/plugins/FreePackages /app/plugins/ASFFreeGames 2>/dev/null || true

              # Cleanup
              rm -rf /app/plugins/tmp
              echo "Plugin installation complete"
              echo "Installed plugins:"
              find /app/plugins -type f -name "*.dll" | sort
          volumeMounts:
            - name: plugins
              mountPath: /app/plugins

    storage:
      longhorn:
        enabled: true
        volumes:
          - name: config
            capacity: 2Gi
          - name: plugins
            capacity: 1Gi

    secrets:
      enabled: true
      itemPath: "vaults/Secrets/items/archisteamfarm-secrets"

    authentik:
      enabled: true
      category: "Gaming"
      displayName: "ArchiSteamFarm"
      externalHost: "https://asf.gateway.services.apocrathia.com"
      icon: "https://cdn.jsdelivr.net/gh/homarr-labs/dashboard-icons/png/archisteamfarm.png"

    httproute:
      enabled: false

    loadbalancer:
      enabled: false
