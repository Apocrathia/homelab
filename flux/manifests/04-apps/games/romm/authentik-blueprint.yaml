---
# yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
version: 1
metadata:
  name: romm
  labels:
    blueprints.goauthentik.io/instantiate: "true"
context: {}
entries:
  # Custom email scope mapping with email_verified set to True
  - model: authentik_providers_oauth2.scopemapping
    state: present
    identifiers:
      name: "romm-email-verified-mapping"
    attrs:
      name: "romm-email-verified-mapping"
      scope_name: email
      description: "Email address with email_verified set to True for RomM"
      expression: |
        return {
            "email": request.user.email,
            "email_verified": True
        }

  # OIDC Provider for ROMM
  - model: authentik_providers_oauth2.oauth2provider
    state: present
    identifiers:
      name: "romm-oidc-provider"
    attrs:
      name: "romm-oidc-provider"
      authorization_flow: !Find [authentik_flows.flow, [slug, "default-provider-authorization-implicit-consent"]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, "default-invalidation-flow"]]
      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "openid"]]
        - !Find [authentik_providers_oauth2.scopemapping, [name, "romm-email-verified-mapping"]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "profile"]]
      sub_mode: "user_username"
      include_claims_in_id_token: true
      issuer_mode: "per_provider"
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, "authentik Self-signed Certificate"]]
      redirect_uris:
        - url: "https://romm.gateway.services.apocrathia.com/api/oauth/openid"
          matching_mode: "strict"
      access_code_validity: "minutes=1"
      access_token_validity: "minutes=5"
      refresh_token_validity: "days=30"
      token_validity: "days=30"
      client_type: "confidential"

  # Application for ROMM
  - model: authentik_core.application
    state: present
    identifiers:
      slug: "romm"
    attrs:
      name: "RomM"
      slug: "romm"
      provider: !Find [authentik_providers_oauth2.oauth2provider, [name, "romm-oidc-provider"]]
      launch_url: "https://romm.gateway.services.apocrathia.com"
      group: "Gaming"
      open_in_new_tab: true
      icon: "https://gitlab.com/Apocrathia/homelab/-/raw/main/flux/manifests/04-apps/games/romm/icon.svg"
      meta_description: "Self-hosted ROM management platform for organizing, scanning, and playing retro games"
      meta_publisher: "RomM"
