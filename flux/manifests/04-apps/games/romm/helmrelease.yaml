---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: romm
  namespace: romm
spec:
  interval: 15m
  chart:
    spec:
      chart: ./helm/generic-app
      # renovate: datasource=git-tags depName=https://gitlab.com/Apocrathia/homelab.git
      version: "0.0.47"
      sourceRef:
        kind: GitRepository
        name: homelab
        namespace: flux-system
      interval: 5m
  values:
    app:
      name: romm
      # renovate: datasource=docker depName=ghcr.io/rommapp/romm
      image: ghcr.io/rommapp/romm:4.5.0
      container:
        name: romm
        port: 8080
        env:
          # ROMM Base Configuration
          - name: ROMM_BASE_URL
            value: "https://romm.gateway.services.apocrathia.com"
          - name: ROMM_BASE_PATH
            value: "/romm"
          - name: ROMM_HOST
            value: "0.0.0.0"
          - name: ROMM_PORT
            value: "8080"
          - name: ROMM_AUTH_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: romm-secrets
                key: auth-secret-key
          - name: TZ
            value: "America/Denver"

          # Database Configuration (PostgreSQL)
          - name: ROMM_DB_DRIVER
            value: "postgresql"
          - name: DB_HOST
            value: "romm-postgres-rw.romm.svc.cluster.local"
          - name: DB_PORT
            value: "5432"
          - name: DB_NAME
            value: "romm"
          - name: DB_USER
            valueFrom:
              secretKeyRef:
                name: romm-secrets
                key: username
          - name: DB_PASSWD
            valueFrom:
              secretKeyRef:
                name: romm-secrets
                key: password

          # Authentication Configuration
          - name: OIDC_ENABLED
            value: "true"
          - name: OIDC_PROVIDER
            value: "authentik"
          - name: DISABLE_USERPASS_LOGIN
            value: "true"
          - name: OIDC_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: romm-secrets
                key: oidc-client-id
          - name: OIDC_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: romm-secrets
                key: oidc-client-secret
          - name: OIDC_REDIRECT_URI
            value: "https://romm.gateway.services.apocrathia.com/api/oauth/openid"
          - name: OIDC_SERVER_APPLICATION_URL
            value: "https://auth.gateway.services.apocrathia.com/application/o/romm"

          - name: IGDB_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: romm-secrets
                key: igdb-client-id
          - name: IGDB_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: romm-secrets
                key: igdb-client-secret
          - name: SCREENSCRAPER_USER
            valueFrom:
              secretKeyRef:
                name: romm-secrets
                key: screenscraper-username
          - name: SCREENSCRAPER_PASSWORD
            valueFrom:
              secretKeyRef:
                name: romm-secrets
                key: screenscraper-password
          # - name: MOBYGAMES_API_KEY
          #   valueFrom:
          #     secretKeyRef:
          #       name: romm-secrets
          #       key: mobygames-api-key
          - name: STEAMGRIDDB_API_KEY
            valueFrom:
              secretKeyRef:
                name: romm-secrets
                key: steamgriddb-api-key
          - name: RETROACHIEVEMENTS_API_KEY
            valueFrom:
              secretKeyRef:
                name: romm-secrets
                key: retroachievements-api-key

          # Toggle-based metadata providers (no API keys required)
          - name: HASHEOUS_API_ENABLED
            value: "true"
          - name: LAUNCHBOX_API_ENABLED
            value: "true"
          - name: PLAYMATCH_API_ENABLED
            value: "true"

          # Scheduled Task Configuration
          - name: ENABLE_SCHEDULED_RESCAN
            value: "true"
          - name: SCHEDULED_RESCAN_CRON
            value: "0 22 * * *" # Daily at 10 PM
          - name: ENABLE_RESCAN_ON_FILESYSTEM_CHANGE
            value: "true"
          - name: RESCAN_ON_FILESYSTEM_CHANGE_DELAY
            value: "5" # Minutes to wait before rescan after filesystem change
          - name: ENABLE_SCHEDULED_UPDATE_SWITCH_TITLEDB
            value: "true"
          - name: SCHEDULED_UPDATE_SWITCH_TITLEDB_CRON
            value: "0 23 * * *" # Daily at 11 PM
          - name: ENABLE_SCHEDULED_UPDATE_LAUNCHBOX_METADATA
            value: "true"
          - name: SCHEDULED_UPDATE_LAUNCHBOX_METADATA_CRON
            value: "0 0 * * *" # Daily at 12 AM
          - name: ENABLE_SCHEDULED_CONVERT_IMAGES_TO_WEBP
            value: "true"
          - name: SCHEDULED_CONVERT_IMAGES_TO_WEBP_CRON
            value: "0 1 * * *" # Daily at 1 AM

          # Emulation Configuration
          - name: EMULATION_ENABLED
            value: "true"
          - name: EMULATION_ENGINE
            value: "emulatorjs"
          - name: EMULATION_ENGINE_URL
            value: "https://romm.gateway.services.apocrathia.com/emulator"

      replicas: 1

      service:
        port: 8080
        targetPort: 8080
        portName: http

      resources:
        requests:
          memory: "1Gi"
          cpu: "50m"
        limits:
          memory: "2Gi"
          cpu: "1000m"

      securityContext:
        readOnlyRootFilesystem: false
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"
        allowPrivilegeEscalation: false

      # Additional writable directories for ROMM
      volumes:
        emptyDir:
          - name: tmp
            mountPath: /tmp
          - name: cache
            mountPath: /romm/cache
          - name: logs
            mountPath: /romm/logs
          - name: nginx-config
            mountPath: /etc/nginx/conf.d
      volumeMounts:
        - name: resources
          mountPath: /romm/resources
        - name: library
          mountPath: /romm/library
        - name: assets
          mountPath: /romm/assets
        - name: config
          mountPath: /romm/config

    storage:
      longhorn:
        enabled: true
        volumes:
          - name: resources
            capacity: 10Gi
          - name: assets
            capacity: 2Gi
          - name: config
            capacity: 1Gi
      smb:
        enabled: true
        volumes:
          - name: library
            source: "//storage.services.apocrathia.com/Games"
            subDir: "Emulation"
            credentialsPath: "vaults/Secrets/items/smb-credentials"

    secrets:
      enabled: true
      itemPath: "vaults/Secrets/items/romm-secrets"

    authentik:
      enabled: false

    httproute:
      enabled: true
      hostname: "romm.gateway.services.apocrathia.com"
