---
# PersistentVolume for SMB-backed import folder
apiVersion: v1
kind: PersistentVolume
metadata:
  name: immich-import-pv
  labels:
    app.kubernetes.io/name: immich
    app.kubernetes.io/component: import
spec:
  capacity:
    storage: 500Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: ""
  mountOptions:
    - dir_mode=0755
    - file_mode=0644
    - uid=1000
    - gid=1000
    - noperm
  csi:
    driver: smb.csi.k8s.io
    volumeHandle: immich-import-pv
    volumeAttributes:
      source: "//storage.services.apocrathia.com/Pictures"
      subDir: "Immich/import"
    nodeStageSecretRef:
      name: immich-library-credentials
      namespace: immich
---
# PersistentVolumeClaim for import folder
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: immich-import
  namespace: immich
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: ""
  volumeName: immich-import-pv
  resources:
    requests:
      storage: 500Gi
---
# CronJob to import photos using Immich CLI
apiVersion: batch/v1
kind: CronJob
metadata:
  name: immich-import
  namespace: immich
spec:
  schedule: "0 3 * * *" # Daily at 3 AM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        spec:
          restartPolicy: Never
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            fsGroup: 1000
            seccompProfile:
              type: RuntimeDefault
          containers:
            - name: immich-cli
              # renovate: datasource=docker depName=ghcr.io/immich-app/immich-cli
              image: ghcr.io/immich-app/immich-cli:v2.4.1
              args:
                - upload
                - --recursive
                - --delete
                - --concurrency
                - "4"
                - /import
              env:
                - name: IMMICH_INSTANCE_URL
                  value: "http://immich-server.immich.svc.cluster.local:2283"
                - name: IMMICH_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: immich-secrets
                      key: immich-api-key
              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                limits:
                  cpu: 1000m
                  memory: 1Gi
              securityContext:
                runAsNonRoot: true
                readOnlyRootFilesystem: true
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
              volumeMounts:
                - name: import
                  mountPath: /import
                - name: tmp
                  mountPath: /tmp
          volumes:
            - name: import
              persistentVolumeClaim:
                claimName: immich-import
            - name: tmp
              emptyDir: {}
