---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: searxng
  namespace: searxng
spec:
  interval: 1h
  chart:
    spec:
      chart: ./helm/generic-app
      # renovate: datasource=git-tags depName=https://gitlab.com/Apocrathia/homelab.git
      version: "0.0.42"
      sourceRef:
        kind: GitRepository
        name: homelab
        namespace: flux-system
      interval: 5m
  values:
    app:
      name: searxng
      # renovate: datasource=docker depName=ghcr.io/searxng/searxng
      image: ghcr.io/searxng/searxng:2025.12.2-fb089ae29
      container:
        name: searxng
        port: 8080
        env:
          - name: SEARXNG_SECRET
            valueFrom:
              secretKeyRef:
                name: searxng-secrets
                key: secret-key
          - name: SEARXNG_BIND_ADDRESS
            value: "0.0.0.0"
          - name: SEARXNG_PORT
            value: "8080"
          - name: SEARXNG_BASE_URL
            value: "https://searxng.gateway.services.apocrathia.com"
      service:
        port: 8080
        targetPort: 8080
      resources:
        requests:
          memory: "256Mi"
          cpu: "100m"
        limits:
          memory: "512Mi"
          cpu: "500m"
      securityContext:
        readOnlyRootFilesystem: false
        runAsUser: 977
        runAsGroup: 977
        fsGroup: 977
      volumeMounts:
        - name: config
          mountPath: /etc/searxng
        - name: cache
          mountPath: /var/cache/searxng

      # Additional writable directories for SearXNG
      volumes:
        emptyDir:
          - name: tmp
            mountPath: /tmp
      # This init container updates the settings.yml file to enable JSON format search
      initContainers:
        - name: update-settings
          # renovate: datasource=docker depName=mikefarah/yq
          image: mikefarah/yq:4.50.1
          command: ["sh", "-c"]
          args:
            - |
              echo "Checking for settings.yml file"
              # Skip update if settings.yml doesn't exist yet (SearXNG will create it on first start)
              if [ ! -f /etc/searxng/settings.yml ]; then
                echo "settings.yml not found, skipping update. SearXNG will create it on first start."
                echo "Restart the pod after SearXNG initializes to apply JSON format."
                exit 0
              fi
              echo "Updating settings.yml to enable JSON format"
              # Ensure search.formats exists and is an array, defaulting to ["html"] if missing
              yq eval '.search.formats = (.search.formats // ["html"])' -i /etc/searxng/settings.yml
              # Check if JSON format is already in the list (check returns empty string if not found)
              JSON_EXISTS=$(yq eval '.search.formats[] | select(. == "json")' /etc/searxng/settings.yml 2>/dev/null)
              if [ -z "$JSON_EXISTS" ]; then
                # Add json to the formats list
                yq eval '.search.formats += ["json"]' -i /etc/searxng/settings.yml
                echo "Added JSON format to settings.yml"
              else
                echo "JSON format already enabled"
              fi
              # Validate the file is still valid YAML
              if ! yq eval '.' /etc/searxng/settings.yml > /dev/null 2>&1; then
                echo "ERROR: settings.yml is invalid after modification"
                exit 1
              fi
              chown 977:977 /etc/searxng/settings.yml
              chmod 644 /etc/searxng/settings.yml
              echo "Settings file updated successfully"
          volumeMounts:
            - name: config
              mountPath: /etc/searxng
          securityContext:
            runAsUser: 0
            runAsGroup: 0
            runAsNonRoot: false

    storage:
      longhorn:
        enabled: true
        volumes:
          - name: config
            capacity: 1Gi
          - name: cache
            capacity: 5Gi

    secrets:
      enabled: true
      itemPath: "vaults/Secrets/items/searxng-secrets"

    authentik:
      enabled: true
      category: "Productivity"
      displayName: "SearXNG"
      externalHost: "https://searxng.gateway.services.apocrathia.com"
      icon: "https://docs.searxng.org/_static/searxng-wordmark.svg"

    httproute:
      enabled: false
